{% extends 'base.html' %}
{% load static %}

{% block title %}รายงานและสถิติ{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h2 class="fw-bold text-primary mb-0"><i class="bi bi-bar-chart-fill me-2"></i>รายงานและสถิติ</h2>
            <p class="text-muted small">ข้อมูล ณ วันที่ {% now "j F Y H:i" %}</p>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">ห้องประชุมทั้งหมด</p>
                            <h3 class="fw-bold text-dark mb-0">{{ total_rooms }}</h3>
                            <small class="text-muted">ห้อง</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                            <i class="bi bi-door-open-fill fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-success rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">การจองวันนี้ (อนุมัติแล้ว)</p>
                            <h3 class="fw-bold text-dark mb-0">{{ bookings_today }}</h3>
                            <small class="text-muted">รายการ</small>
                        </div>
                        <div class="bg-success bg-opacity-10 text-success p-3 rounded-circle">
                            <i class="bi bi-calendar-check-fill fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-warning rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">รออนุมัติ</p>
                            <h3 class="fw-bold text-dark mb-0">{{ pending_bookings }}</h3>
                            <small class="text-muted">รายการ</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-circle">
                            <i class="bi bi-hourglass-split fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-info rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">ผู้ใช้ทั้งหมด</p>
                            <h3 class="fw-bold text-dark mb-0">{{ total_users }}</h3>
                            <small class="text-muted">คน</small>
                        </div>
                        <div class="bg-info bg-opacity-10 text-info p-3 rounded-circle">
                            <i class="bi bi-people-fill fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 mb-4 bg-light">
        <div class="card-body py-3">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="small fw-bold text-muted mb-1">ช่วงเวลา</label>
                    <select name="period" class="form-select border-0 shadow-sm">
                        <option value="monthly" {% if current_period == 'monthly' %}selected{% endif %}>รายเดือน (30 วันล่าสุด)</option>
                        <option value="weekly" {% if current_period == 'weekly' %}selected{% endif %}>รายสัปดาห์ (7 วันล่าสุด)</option>
                        <option value="daily" {% if current_period == 'daily' %}selected{% endif %}>รายวัน (วันนี้)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted mb-1">แผนก</label>
                    <select name="department" class="form-select border-0 shadow-sm">
                        <option value="">-- ทุกแผนก --</option>
                        {% for dept in all_departments %}
                            <option value="{{ dept }}" {% if current_department == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm fw-bold">
                        <i class="bi bi-funnel-fill me-2"></i>กรองข้อมูล
                    </button>
                </div>
                <div class="col-md-3">
                    <div class="dropdown w-100">
                        <button class="btn btn-secondary w-100 rounded-pill shadow-sm dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>Export รายงาน
                        </button>
                        <ul class="dropdown-menu border-0 shadow w-100">
                            <li><a class="dropdown-item py-2" href="{% url 'export_reports_excel' %}?period={{ current_period }}&department={{ current_department }}"><i class="bi bi-file-earmark-excel text-success me-2"></i>Excel (CSV)</a></li>
                            <li><a class="dropdown-item py-2" href="{% url 'export_reports_pdf' %}?period={{ current_period }}&department={{ current_department }}"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>PDF File</a></li>
                        </ul>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold text-primary mb-0"><i class="bi bi-pie-chart-fill me-2"></i>การใช้งานห้อง ({{ report_title }})</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="width: 100%; max-width: 350px;">
                        <canvas id="roomChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold text-info mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>การใช้งานตามแผนก ({{ report_title }})</h5>
                </div>
                <div class="card-body">
                    <canvas id="deptChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const roomLabels = {{ room_usage_labels|safe }};
        const roomData = {{ room_usage_data|safe }};
        const deptLabels = {{ dept_usage_labels|safe }};
        const deptData = {{ dept_usage_data|safe }};

        // --- 1. Pie Chart ---
        const ctxRoom = document.getElementById('roomChart').getContext('2d');
        const hasRoomData = roomData.length > 0;
        
        new Chart(ctxRoom, {
            type: 'doughnut',
            data: {
                labels: hasRoomData ? roomLabels : ['ไม่มีข้อมูล'],
                datasets: [{
                    data: hasRoomData ? roomData : [1],
                    backgroundColor: hasRoomData 
                        ? ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'] 
                        : ['#e9ecef'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { enabled: hasRoomData }
                }
            }
        });

        // --- 2. Bar Chart ---
        const ctxDept = document.getElementById('deptChart').getContext('2d');
        const hasDeptData = deptData.length > 0;

        new Chart(ctxDept, {
            type: 'bar',
            data: {
                labels: hasDeptData ? deptLabels : ['ไม่มีข้อมูล'],
                datasets: [{
                    label: 'จำนวนครั้งที่จอง',
                    data: hasDeptData ? deptData : [0],
                    backgroundColor: '#0dcaf0',
                    borderRadius: 5,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1 } 
                    },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    });
</script>
{% endblock %}