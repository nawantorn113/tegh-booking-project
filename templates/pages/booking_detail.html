{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{# ❌ ลบ {% load tz %} ออก ❌ #}

{% block title %}รายละเอียดการจอง - {{ booking.title }}{% endblock %}

{% block page_title %}รายละเอียดการจอง{% endblock %}

{% block extra_head %}
<style>
    /* สไตล์เล็กน้อยสำหรับสถานะ */
    .status-pending { color: var(--bs-warning); font-weight: bold; }
    .status-approved { color: var(--bs-success); font-weight: bold; }
    .status-rejected { color: var(--bs-danger); font-weight: bold; }
    .status-cancelled { color: var(--bs-secondary); font-weight: bold; text-decoration: line-through; }
    .detail-label { font-weight: bold; color: var(--bs-secondary); display: block; margin-bottom: 0.2rem; font-size: 0.9em;} /* ปรับปรุง Label */
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                 <h4 class="mb-0 text-primary"><i class="bi bi-calendar-event me-2"></i>{{ booking.title }}</h4>
                 {# ปุ่มกลับ ใช้ history.back() หรือ url dashboard/history #}
                 <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm rounded-pill">
                     <i class="bi bi-arrow-left me-1"></i> กลับ
                 </a>
            </div>
            <hr class="mb-4"> {# เพิ่ม Margin Bottom #}

            <div class="row g-4"> {# เพิ่ม Gap ระหว่าง row #}
                <div class="col-md-6">
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-building me-1"></i>ห้องประชุม:</span>
                        {{ booking.room.name }}
                    </p>
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-person-fill me-1"></i>ผู้จอง:</span>
                        {{ booking.booked_by.get_full_name|default:booking.booked_by.username }} ({{ booking.department|default:"-" }})
                    </p>
                    {% if booking.chairman %}
                        <p class="mb-3">
                            <span class="detail-label"><i class="bi bi-person-badge-fill me-1"></i>ประธานในที่ประชุม:</span>
                            {{ booking.chairman }}
                        </p>
                    {% endif %}
                 </div>
                 <div class="col-md-6">
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-clock-fill me-1"></i>วัน/เวลา:</span>
                        
                        {# --- ✅ แก้ไข: เอา {% timezone %} ออก --- #}
                        {{ booking.start_time|date:"d M Y H:i" }} - {{ booking.end_time|date:"H:i" }}
                        {# --- ----------------------------------- #}
                        
                        <span class="text-muted small">({{ booking.start_time|timesince:booking.end_time }})</span> {# แสดงระยะเวลา #}
                    </p>
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-people-fill me-1"></i>จำนวนผู้เข้าร่วม:</span>
                         {{ booking.participant_count }} คน
                    </p>
                    <p class="mb-3">
                        <span class="detail-label">สถานะ:</span>
                        {% if booking.status == 'PENDING' %}
                            <span class="status-pending"><i class="bi bi-hourglass-split me-1"></i>{{ booking.get_status_display }}</span>
                        {% elif booking.status == 'APPROVED' %}
                            <span class="status-approved"><i class="bi bi-check-circle-fill me-1"></i>{{ booking.get_status_display }}</span>
                        {% elif booking.status == 'REJECTED' %}
                            <span class="status-rejected"><i class="bi bi-x-octagon-fill me-1"></i>{{ booking.get_status_display }}</span>
                        {% elif booking.status == 'CANCELLED' %}
                            <span class="status-cancelled"><i class="bi bi-slash-circle-fill me-1"></i>{{ booking.get_status_display }}</span>
                        {% else %}
                            <span>{{ booking.get_status_display }}</span>
                        {% endif %}
                    </p>
                </div>

                <div class="col-12">
                     <p class="mb-3">
                         <span class="detail-label"><i class="bi bi-text-left me-1"></i>รายละเอียด/วาระ:</span>
                         {{ booking.description|linebreaksbr|default:"-" }}
                     </p>
                </div>

                {% if booking.participants.exists %}
                <div class="col-12">
                    <p class="detail-label"><i class="bi bi-person-lines-fill me-1"></i>รายชื่อผู้เข้าร่วม:</p>
                    <ul class="list-group list-group-flush list-group-numbered small mb-3"> {# ใช้ list-group #}
                        {% for participant in booking.participants.all %}
                            <li class="list-group-item border-0 px-0 py-1">{{ participant.get_full_name|default:participant.username }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                 {% if booking.additional_requests %}
                 <div class="col-12">
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-chat-dots-fill me-1"></i>คำขอเพิ่มเติม:</span>
                         {{ booking.additional_requests|linebreaksbr }}
                    </p>
                 </div>
                 {% endif %}

                 {% if booking.presentation_file or booking.attachment %}
                 <div class="col-12">
                     <p class="detail-label"><i class="bi bi-paperclip me-1"></i>ไฟล์แนบ:</p>
                     <ul class="list-unstyled">
                        {% if booking.presentation_file %}
                        <li class="mb-1">
                            <i class="bi bi-file-earmark-slides-fill me-1 text-danger"></i>
                            <a href="{{ booking.presentation_file.url }}" target="_blank" class="link-dark">ไฟล์นำเสนอ</a>
                            {% if booking.presentation_file.size %}
                            <span class="text-muted small">({{ booking.presentation_file.size|filesizeformat }})</span>
                            {% endif %}
                        </li>
                        {% endif %}
                        {% if booking.attachment %}
                         <li class="mb-1">
                            <i class="bi bi-file-earmark-fill me-1 text-primary"></i>
                            <a href="{{ booking.attachment.url }}" target="_blank" class="link-dark">ไฟล์แนบอื่นๆ</a>
                             {% if booking.attachment.size %}
                             <span class="text-muted small">({{ booking.attachment.size|filesizeformat }})</span>
                             {% endif %}
                        </li>
                        {% endif %}
                    </ul>
                 </div>
                 {% endif %}

                 {% if booking.additional_notes %}
                 <div class="col-12">
                    <p class="mb-3">
                        <span class="detail-label"><i class="bi bi-journal-text me-1"></i>หมายเหตุ:</span>
                         {{ booking.additional_notes|linebreaksbr }}
                    </p>
                 </div>
                 {% endif %}
            </div>

            {# --- ส่วนปุ่ม แก้ไข/ยกเลิก --- #}
            <div class="mt-4 pt-3 border-top d-flex justify-content-end gap-2">
                {% if request.user == booking.booked_by or is_admin_user %}
                    <a href="{% url 'edit_booking' booking.id %}" class="btn btn-warning rounded-pill px-3">
                        <i class="bi bi-pencil-square me-1"></i> แก้ไขข้อมูล
                    </a>
                    {% if booking.status != 'CANCELLED' and booking.status != 'REJECTED' %}
                    <form action="{% url 'delete_booking' booking.id %}" method="post" class="d-inline" onsubmit="return confirm('คุณต้องการยกเลิกการจอง \"{{ booking.title|escapejs }}\" ใช่หรือไม่?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger rounded-pill px-3">
                            <i class="bi bi-x-circle me-1"></i> ยกเลิกการจอง
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
            {# --- สิ้นสุดส่วนปุ่ม --- #}

        </div> {# End card-body #}
    </div> {# End card #}
</div> {# End container #}
{% endblock %}