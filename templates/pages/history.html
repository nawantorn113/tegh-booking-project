{% extends 'base.html' %}
{% load static %}
{% block title %}ประวัติการจอง{% endblock %}

{% block content %}
    <!-- 
    (ลบ <div class="container main-content-wrapper"> ที่ซ้ำซ้อนออกแล้ว) 
    (การทำเช่นนี้จะแก้ปัญหา "ช่องว่าง" ด้านบนที่กว้างเกินไป)
    -->
    
    <!-- === 1. หัวข้อหน้า === -->
    <div class="page-header">
        <h5 class="mb-0">ประวัติการจองของคุณ</h5>
    </div>

    <!-- === 2. รายการจอง (ตารางที่ถูกต้อง) === -->
    <div class="content-card shadow-sm border">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">หัวข้อการจอง</th>
                        <th scope="col">ห้องประชุม</th>
                        <th scope="col">วัน/เวลา</th>
                        <th scope="col">สถานะ</th>
                        <th scope="col" class="text-end">จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in my_bookings %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ booking.title }}</div>
                            <small class="text-muted">{{ booking.department|default:"-" }}</small>
                        </td>
                        <td>{{ booking.room.name }}</td>
                        <td>
                            <div>{{ booking.start_time|date:"d M Y" }}</div>
                            <small class="text-muted">{{ booking.start_time|date:"H:i" }} - {{ booking.end_time|date:"H:i" }} น.</small>
                        </td>
                        <td>
                            <!-- (ป้ายสถานะ) -->
                            {% if booking.status == 'APPROVED' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">อนุมัติแล้ว</span>
                            {% elif booking.status == 'PENDING' %}
                                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">รออนุมัติ</span>
                            {% elif booking.status == 'REJECTED' %}
                                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">ปฏิเสธ</span>
                            {% elif booking.status == 'CANCELLED' %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">ยกเลิก</span>
                            {% endif %}
                        </td>
                        
                        <!-- (ส่วนจัดการ ที่มี Logic ตรวจสอบเวลา) -->
                        <td class="text-end">
                            
                            <!-- 1. ปุ่ม "ดูรายละเอียด" (แสดงตลอด) -->
                            <a href="{% url 'booking_detail' booking.id %}" class="btn btn-sm btn-outline-info px-3">
                                <i class="bi bi-search me-1"></i> รายละเอียด
                            </a>
                            
                            <!-- 2. เช็คว่าสถานะยัง Active (PENDING หรือ APPROVED) -->
                            {% if booking.status == 'PENDING' or booking.status == 'APPROVED' %}
                                
                                <!-- 3. (ใหม่!) เช็คว่า (ยังไม่จบ) หรือ (เป็นแอดมิน) -->
                                {% if booking.end_time > now_time or is_admin_user %}
                                    
                                    <!-- ปุ่ม "ยกเลิก" -->
                                    <form action="{% url 'delete_booking_view' booking.id %}" method="POST" class="d-inline ms-1" 
                                          onsubmit="return confirm('คุณต้องการยกเลิกการจองนี้ใช่หรือไม่?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-x-circle"></i> ยกเลิก
                                        </button>
                                    </form>

                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="bi bi-calendar-x fs-4 d-block mb-2"></i>
                            ไม่พบประวัติการจอง
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div> <!-- .content-card -->

{% endblock %}
