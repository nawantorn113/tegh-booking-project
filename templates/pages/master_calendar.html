{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />

<style>
    :root {
        --fc-border-color: #e9ecef;
        --fc-today-bg-color: #f8f9fa;
    }
    .fc { font-family: 'Kanit', sans-serif; }
    .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 500; }
    #calendar { min-height: 700px; }
    
    /* (‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Event) */
    .fc-event-main-frame {
        padding: 2px 4px;
        font-size: 0.8rem;
    }
    .fc-event-title-container {
        font-weight: 500;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">

    {# --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á --- #}
    <div class="content-card shadow-sm border p-3 p-md-4">
        <h5 class="mb-3">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
        <div id="calendar"></div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
window.onload = function() {
    
    if (typeof FullCalendar === 'undefined' || typeof $ === 'undefined') {
        console.error("Required JS libraries not loaded (jQuery or FullCalendar).");
        document.getElementById('calendar').innerHTML = '<div class="alert alert-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä (Ctrl+Shift+R)</div>';
        return; 
    }
    
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        
        // --- üí°üí°üí° [‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] üí°üí°üí° ---
        // (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô View ‡πÄ‡∏õ‡πá‡∏ô 'dayGridMonth' (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô))
        initialView: 'dayGridMonth', 
        locale: 'th',
        firstDay: 0, // (0 = Sunday)
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
        },
        buttonText: { 
            today:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 
            month:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 
            week:'‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
            day:'‡∏ß‡∏±‡∏ô'     
        },
        
        // (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á All-day ‡∏Ç‡∏≠‡∏á 'timeGrid')
        allDaySlot: true, 
        slotMinTime: '07:30:00', 
        slotMaxTime: '18:00:00',
        
        selectable: false, // (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
        nowIndicator: true, 
        
        events: "{% url 'bookings_api' %}", 

        // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Event ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
        eventDataTransform: function(eventData) {
            let props = eventData.extendedProps || {};
            var now = new Date();
            var eventStart = new Date(eventData.start);
            var eventEnd = new Date(eventData.end);
            
            var statusText = "";
            
            if (props.status === 'PENDING') {
                eventData.backgroundColor = '#ffc107'; 
                eventData.borderColor = '#ffc107';
                statusText = "[‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥] "; 
            
            } else if (props.status === 'APPROVED') {
                if (now >= eventStart && now < eventEnd) {
                    eventData.backgroundColor = '#dc3545'; 
                    eventData.borderColor = '#dc3545';
                    statusText = "[‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô] ";
                } else {
                    eventData.backgroundColor = '#198754'; 
                    eventData.borderColor = '#198754';
                    statusText = "[‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß] ";
                }
                
            } else {
                eventData.display = 'none';
            }
            
            // (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Title)
            eventData.title = `[${props.room_name}] ${statusText}${eventData.title}`;
            
            return eventData;
        },
        // --- üí°üí°üí° [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] üí°üí°üí° ---

        eventClick: function(info) {
            // (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å Event ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Detail)
            window.location.href = "{% url 'booking_detail' 0 %}".replace('0', info.event.id);
        }
    });
    
    calendar.render();
};
</script>
{% endblock %}