{% extends "base.html" %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°{% endblock %}

{% block content %}
<div class="container-fluid p-0 p-md-3">
    <div class="card shadow-sm border-0 rounded-0 rounded-md-3">
        
        <div class="card-header bg-white py-3">
            <div class="row align-items-center gy-2"> <div class="col-12 col-md-6 d-flex align-items-center gap-2">
                    <h5 class="mb-0 text-primary fw-bold">
                        <i class="bi bi-calendar-check-fill"></i> 
                        <span class="d-none d-sm-inline">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°</span>
                        <span class="d-inline d-sm-none">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á</span>
                    </h5>
                    <span class="badge bg-success d-none d-sm-inline">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                    <span class="badge bg-warning text-dark d-none d-sm-inline">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                </div>

                <div class="col-12 col-md-6 d-flex gap-2 justify-content-md-end">
                    <select id="roomFilter" class="form-select form-select-sm" style="max-width: 100%;">
                        <option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                        {% for room in all_rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                    
                    {% if user.is_authenticated %}
                    <a href="{% url 'dashboard' %}" class="btn btn-primary btn-sm text-nowrap">
                        <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card-body p-0 p-md-3">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm"> 
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalEventTitle" class="text-primary fw-bold mb-3">-</h6>
                
                <div class="d-flex flex-column gap-2 text-sm">
                    <div>
                        <small class="text-muted">üìÖ ‡πÄ‡∏ß‡∏•‡∏≤:</small>
                        <div id="modalEventTime" class="fw-bold text-dark">-</div>
                    </div>
                    <div>
                        <small class="text-muted">üö™ ‡∏´‡πâ‡∏≠‡∏á:</small>
                        <div id="modalEventRoom" class="text-dark">-</div>
                    </div>
                    <div>
                        <small class="text-muted">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</small>
                        <div id="modalEventUser" class="text-dark">-</div>
                    </div>
                </div>
                
                <div class="d-grid mt-3">
                    <a href="#" id="modalDetailLink" class="btn btn-outline-primary btn-sm">
                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
    /* CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    #calendar {
        font-family: 'Sarabun', sans-serif;
        min-height: 85vh; 
    }

    /* --- üì± MOBILE FIX : ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà --- */
    @media (max-width: 768px) {
        
        /* 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Toolbar ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏°‡∏≤‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (Column) */
        .fc-header-toolbar {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            align-items: stretch !important; /* ‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        }

        /* 2. ‡∏à‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
        .fc-toolbar-chunk {
            display: flex !important;
            justify-content: space-between !important; /* ‡πÅ‡∏¢‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
            width: 100% !important; 
        }

        /* 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô */
        .fc-toolbar-title {
            font-size: 1.25rem !important;
        }

        /* 4. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Today ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .fc-today-button {
            display: none !important;
        }

        /* 5. ‡∏õ‡∏£‡∏±‡∏ö List View ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢ */
        .fc-list-event-title {
            font-weight: 600 !important;
        }
        .fc-list-day-cushion {
            background-color: #f8f9fa !important;
            position: sticky;
            top: 0;
            z-index: 5;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        function isMobile() {
            return window.innerWidth < 768;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'th',
            timeZone: 'Asia/Bangkok',
            themeSystem: 'bootstrap5',
            
            // ======================================================
            // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô List View ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            // ======================================================
            initialView: isMobile() ? 'listMonth' : 'dayGridMonth',
            
            height: 'auto',
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
            headerToolbar: {
                // ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏ã‡πà‡∏≠‡∏ô Today, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å CSS ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏≠‡∏á
                left: isMobile() ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: isMobile() ? 'listMonth' : 'dayGridMonth,timeGridWeek,listWeek'
            },
            
            buttonText: {
                today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                day: '‡∏ß‡∏±‡∏ô',
                list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                listMonth: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'
            },
            
            views: {
                listMonth: { buttonText: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' }
            },

            events: '/api/bookings_api/', 
            
            eventClick: function(info) {
                document.getElementById('modalEventTitle').innerText = info.event.title;
                document.getElementById('modalEventTime').innerText = 
                    info.event.start.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) + ' - ' +
                    (info.event.end ? info.event.end.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) : '');
                
                document.getElementById('modalEventRoom').innerText = info.event.extendedProps.room || '-';
                document.getElementById('modalEventUser').innerText = info.event.extendedProps.user || '-';
                
                var detailBtn = document.getElementById('modalDetailLink');
                detailBtn.href = '/booking/' + info.event.id + '/detail/';
                
                eventModal.show();
            },

            // Auto Resize: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô View ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠
            windowResize: function(view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listMonth');
                } else {
                    calendar.changeView('dayGridMonth');
                }
            }
        });

        calendar.render();

        // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
        document.getElementById('roomFilter').addEventListener('change', function() {
            var roomId = this.value;
            var newSource = {
                url: '/api/bookings_api/',
                extraParams: roomId ? { room_id: roomId } : {}
            };
            var oldSource = calendar.getEventSources()[0];
            oldSource.remove();
            calendar.addEventSource(newSource);
        });
    });
</script>
{% endblock %}