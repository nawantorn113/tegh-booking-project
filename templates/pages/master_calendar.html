{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°{% if is_public_view %} (‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞){% endif %}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
<style>
    #calendar { min-height: 700px; }
    .fc-event { cursor: pointer; border: none; } /* ‡∏•‡∏ö‡∏Ç‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Badge ‡πÉ‡∏ô Legend */
    .badge-legend { font-size: 0.9rem; font-weight: 400; padding: 6px 10px; }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex align-items-center w-100 mb-3" id="page-header">
    <h5 class="mb-0 text-primary">
        <i class="bi bi-calendar3-range me-2"></i> 
        ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 
        {% if is_public_view %} <span class="text-muted fs-6">(‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞)</span>{% endif %}
    </h5>
    
    <div class="ms-auto"> 
        {% if not user.is_authenticated %}
        <a href="{% url 'login' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
            <i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </a>
        {% else %}
         <span class="text-muted me-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, {{ user.get_full_name|default:user.username }}</span>
        {% endif %}
    </div>
</div>

<div class="container-fluid px-0">
    <div class="content-card shadow-sm border p-3 p-md-4">
        
        <div class="alert alert-light border mb-3 d-flex flex-wrap gap-2 align-items-center">
            <span class="badge badge-legend" style="background-color: #198754;">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
            <span class="badge badge-legend text-dark" style="background-color: #0dcaf0;">‡∏™‡∏µ‡∏ü‡πâ‡∏≤ = ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            <span class="badge badge-legend text-dark" style="background-color: #ffc107;">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á = ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
            <span class="badge badge-legend" style="background-color: #fd7e14;">‡∏™‡∏µ‡∏™‡πâ‡∏° = ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
            <span class="badge badge-legend" style="background-color: #dc3545;">‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>
            <span class="text-muted small ms-auto d-none d-md-block"><i class="bi bi-info-circle"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
        </div>
        
        <div id="calendar"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() { 
    
    var calendarEl = document.getElementById('calendar');
    var isPublicView = '{{ is_public_view|yesno:"true,false" }}' === 'true';

    var calendar = new FullCalendar.Calendar(calendarEl, {
        
        initialView: 'dayGridMonth', 
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
        },
        
        events: {
            url: "{% url 'bookings_api' %}", 
            method: 'GET',
            extraParams: {
                public: isPublicView ? 'true' : 'false'
            },
            failure: function() {
                console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        },

        locale: 'th',
        firstDay: 0, 
        height: 'auto',
        dayMaxEvents: true,
        
        // üö® [CRITICAL UPDATE] Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        eventDidMount: function(info) {
            var props = info.event.extendedProps;
            var now = new Date(); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            var start = info.event.start;
            var end = info.event.end;
            var el = info.el;
            
            // Default Style
            el.style.color = '#ffffff'; 

            if (props.status === 'PENDING') {
                // üü° ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -> ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                el.style.backgroundColor = '#ffc107'; 
                el.style.color = '#000000'; // ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥
            
            } else if (props.status === 'APPROVED') {
                
                if (now >= end) {
                    // üü† ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) -> ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
                    el.style.backgroundColor = '#fd7e14'; 
                
                } else if (now >= start && now < end) {
                    // üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ) -> ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                    el.style.backgroundColor = '#0dcaf0'; 
                    el.style.color = '#000000'; // ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥
                
                } else {
                    // üü¢ ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤) -> ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    el.style.backgroundColor = '#198754'; 
                }
                
            } else if (props.status === 'CANCELLED' || props.status === 'REJECTED') {
                // üî¥ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò -> ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                el.style.backgroundColor = '#dc3545'; 
            }
        },
        
        eventClick: function(info) {
            window.location.href = "{% url 'booking_detail' 0 %}".replace('0', info.event.id);
        },

        selectable: true,
        select: function(info) {
            {% if not user.is_authenticated %}
                if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô)')) {
                    window.location.href = "{% url 'login' %}";
                }
            {% else %}
                // ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                window.location.href = "{% url 'create_booking' all_rooms.0.id %}?start=" + info.startStr + "&end=" + info.endStr;
            {% endif %}
        }
    });
    
    calendar.render();
});
</script>
{% endblock %}