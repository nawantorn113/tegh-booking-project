{% extends 'base.html' %}
{% load static %}

{% block title %}ปฏิทินรวม{% endblock %}

{% block extra_head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style> 
    .fc-event { cursor: pointer; border: none; } 
    /* ปรับแต่งปฏิทินให้ดูสะอาดตา */
    .fc-daygrid-day-number { color: #333; font-weight: 500; text-decoration: none; }
    .fc-col-header-cell-cushion { color: #555; text-decoration: none; font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-primary">
                <i class="bi bi-calendar3-range me-2"></i>ปฏิทินรวมทุกห้อง
            </h5>
        </div>
        <div class="card-body p-4">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="modalTitle">รายละเอียด</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="small text-muted fw-bold text-uppercase">ห้องประชุม</label>
                    <div id="modalRoom" class="fs-5 text-primary fw-bold"></div>
                </div>
                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-2 bg-light rounded border">
                            <label class="small text-muted d-block">ผู้จอง</label>
                            <strong id="modalUser" class="text-dark"></strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-light rounded border">
                            <label class="small text-muted d-block">สถานะ</label>
                            <span id="modalStatusBadge"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light p-3">
                <a href="#" id="modalLink" class="btn btn-primary rounded-pill w-100 shadow-sm">
                    ดูรายละเอียดเต็ม
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/th.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'th',
            initialView: 'dayGridMonth',
            
            // [แก้ไข] ตั้งค่าชื่อปุ่มเฉพาะ View
            views: {
                listMonth: { buttonText: 'รายการ' } 
            },

            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            
            events: "{% url 'bookings_api' %}?t=" + new Date().getTime(),
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },

            // เมื่อคลิกที่ Event ในปฏิทิน
            eventClick: function(info) {
                // ใส่ข้อมูลลงใน Modal
                document.getElementById('modalTitle').innerText = info.event.title;
                document.getElementById('modalRoom').innerText = info.event.extendedProps.room;
                document.getElementById('modalUser').innerText = info.event.extendedProps.user;
                
                // สร้างลิงก์ไปยังหน้ารายละเอียด
                document.getElementById('modalLink').href = "/booking/" + info.event.id + "/detail/";

                // จัดการสีป้ายสถานะ (Badge)
                let statusKey = info.event.extendedProps.status;
                let badgeElem = document.getElementById('modalStatusBadge');
                let badgeClass = 'badge rounded-pill fs-6 w-100 ';
                let statusText = statusKey;

                if(statusKey === 'APPROVED') {
                    statusText = 'อนุมัติแล้ว'; badgeClass += 'bg-success';
                } else if(statusKey === 'PENDING') {
                    statusText = 'รออนุมัติ'; badgeClass += 'bg-warning text-dark';
                } else if(statusKey === 'REJECTED') {
                    statusText = 'ไม่อนุมัติ'; badgeClass += 'bg-danger';
                } else if(statusKey === 'CANCELLED') {
                    statusText = 'ยกเลิก'; badgeClass += 'bg-secondary';
                }
                
                badgeElem.className = badgeClass;
                badgeElem.innerText = statusText;

                // เปิด Modal
                var myModal = new bootstrap.Modal(document.getElementById('eventModal'));
                myModal.show();
            }
        });
        calendar.render();
    });
</script>
{% endblock %}