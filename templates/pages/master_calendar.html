{% extends "base.html" %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á{% endblock %}

{% block extra_head %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        #calendar {
            font-family: 'Sarabun', sans-serif;
            font-size: 0.9rem;
        }

        /* ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .bg-active { background-color: #0d6efd !important; color: white !important; border-left: 4px solid #0a58ca !important; }
        .bg-approved { background-color: #198754 !important; color: white !important; border-left: 4px solid #0f5132 !important; }
        .bg-pending { background-color: #ffc107 !important; color: #212529 !important; border-left: 4px solid #cc9a06 !important; }
        .bg-rejected { background-color: #fd7e14 !important; color: white !important; border-left: 4px solid #e36a09 !important; }
        .bg-cancelled { background-color: #dc3545 !important; color: white !important; border-left: 4px solid #b02a37 !important; }
        .bg-past { background-color: #6c757d !important; color: white !important; opacity: 0.8; }
        .bg-maintenance { background-color: #212529 !important; color: white !important; }
        .bg-cleaning { background-color: #0dcaf0 !important; color: white !important; border-left: 4px solid #0aa2c0 !important; }

        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á Event (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏Å) */
        .custom-event-content {
            padding: 3px 5px;
            line-height: 1.25;
            font-size: 0.75rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .fc-event { 
            border: none !important; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            cursor: pointer; 
            border-radius: 3px; 
            margin-bottom: 1px;
        }
        
        @media (max-width: 768px) {
            .fc-toolbar-title { font-size: 1.1rem !important; }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-3"> 
    
    <div class="card shadow-sm border-0 rounded-3 mb-3">
        <div class="card-body py-2 px-3">
            <div class="row align-items-center gy-2">
                
                <div class="col-12 col-lg-7">
                    <div class="d-flex align-items-center mb-1">
                        <h5 class="mb-0 text-primary fw-bold">
                            <i class="bi bi-calendar-check-fill me-2"></i>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°
                        </h5>
                    </div><br>
                    <small class="text-muted fw-bold d-block mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</small>
                        <div class="d-flex gap-2 align-items-center small flex-wrap">
                            <span class="badge bg-primary fw-normal px-2 py-1"><i class="bi bi-broadcast me-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                            <span class="badge bg-success fw-normal px-2 py-1"><i class="bi bi-check-circle-fill me-1"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="badge bg-warning text-dark fw-normal px-2 py-1"><i class="bi bi-hourglass-split me-1"></i>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span> 
                            <span class="badge bg-secondary fw-normal px-2 py-1"><i class="bi bi-clock-history me-1"></i>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="badge fw-normal px-2 py-1" style="background-color: #fd7e14; color: white;"><i class="bi bi-x-circle-fill me-1"></i>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            <span class="badge bg-danger fw-normal px-2 py-1"><i class="bi bi-slash-circle-fill me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                            <span class="badge bg-info text-dark fw-normal px-2 py-1"><i class="bi bi-stars me-1"></i>‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</span>
                    </div>
                </div>

                <div class="col-12 col-lg-5 d-flex gap-2 justify-content-lg-end align-items-center">
                    <select id="roomFilter" class="form-select form-select-sm shadow-none border-secondary-subtle" style="max-width: 180px;">
                        <option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                        {% for room in all_rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                    
                    {% if user.is_authenticated %}
                    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-primary text-nowrap px-3">
                        <i class="bi bi-plus-lg"></i> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-2">
            <div id="calendar"></div>
        </div>
    </div>

</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm"> 
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalEventTitle" class="text-primary fw-bold mb-3">-</h6>
                <div class="d-flex flex-column gap-2 text-sm">
                    <div><small class="text-muted">üìÖ ‡πÄ‡∏ß‡∏•‡∏≤:</small><div id="modalEventTime" class="fw-bold text-dark">-</div></div>
                    <div><small class="text-muted">üö™ ‡∏´‡πâ‡∏≠‡∏á:</small><div id="modalEventRoom" class="text-dark">-</div></div>
                    <div><small class="text-muted">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</small><div id="modalEventUser" class="text-dark">-</div></div>
                </div>
                <div class="d-grid mt-3">
                    <a href="#" id="modalDetailLink" class="btn btn-outline-primary btn-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        function isMobile() { return window.innerWidth < 768; }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'th',
            timeZone: 'Asia/Bangkok',
            themeSystem: 'bootstrap5',
            initialView: isMobile() ? 'listMonth' : 'dayGridMonth',
            
            // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)
            height: '75vh', 
            // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á
            aspectRatio: 2.2,

            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: isMobile() ? 'listMonth' : 'dayGridMonth,listMonth'
            },
            
            buttonText: {
                today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
            },
            views: { listMonth: { buttonText: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' } },

            events: "{% url 'bookings_api' %}", 
            
            eventContent: function(arg) {
                let timeText = arg.event.start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                if(arg.event.end) timeText += ' - ' + arg.event.end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                
                let roomName = arg.event.extendedProps.room || '-';
                let userName = arg.event.extendedProps.user || '-'; // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á
                let title = arg.event.title;
                let status = arg.event.extendedProps.status;

                // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î)
                return { html: `
                    <div class="custom-event-content">
                        <div class="fw-bold text-truncate" style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 1px; margin-bottom: 1px;">
                           ${roomName}
                        </div>
                        <div class="text-truncate fw-bold">${title}</div>
                        <div class="d-flex justify-content-between align-items-center opacity-75" style="font-size: 0.7rem;">
                            <span>${timeText}</span>
                            <span class="text-truncate ms-1" style="max-width: 60px;"><i class="bi bi-person-fill"></i> ${userName}</span>
                        </div>
                    </div>
                `};
            },

            eventClassNames: function(arg) {
                let s = arg.event.extendedProps.status;
                let now = new Date();
                let end = arg.event.end || arg.event.start;
                
                if (arg.event.id.toString().startsWith('maint_')) return ['bg-maintenance'];
                if (s === 'CLEANING') return ['bg-cleaning']; 
                if (s === 'CANCELLED') return ['bg-cancelled']; 
                if (s === 'REJECTED') return ['bg-rejected']; 
                if (end < now) return ['bg-past']; 
                if (s === 'PENDING') return ['bg-pending'];
                
                if (s === 'APPROVED') {
                    if (arg.event.start <= now && now <= end) return ['bg-active']; 
                    return ['bg-approved']; 
                }
                return ['bg-secondary'];
            },
            
            eventClick: function(info) {
                if (info.event.id.toString().startsWith('maint_')) return;
                document.getElementById('modalEventTitle').innerText = info.event.title;
                document.getElementById('modalEventTime').innerText = 
                    info.event.start.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) + ' - ' +
                    (info.event.end ? info.event.end.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) : '');
                
                document.getElementById('modalEventRoom').innerText = info.event.extendedProps.room || '-';
                document.getElementById('modalEventUser').innerText = info.event.extendedProps.user || '-';
                document.getElementById('modalDetailLink').href = '/booking/' + info.event.id + '/detail/';
                eventModal.show();
            },

            windowResize: function(view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listMonth');
                    calendar.setOption('height', 'auto');
                } else {
                    calendar.changeView('dayGridMonth');
                    calendar.setOption('height', '75vh');
                }
            }
        });

        calendar.render();

        document.getElementById('roomFilter').addEventListener('change', function() {
            var roomId = this.value;
            var newSource = {
                url: "{% url 'bookings_api' %}", 
                extraParams: roomId ? { room_id: roomId } : {}
            };
            var oldSource = calendar.getEventSources()[0];
            oldSource.remove();
            calendar.addEventSource(newSource);
        });
    });
</script>
{% endblock %}