{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°{% if is_public_view %} (‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞){% endif %}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
<style>
    #calendar { min-height: 700px; }
    .fc-event { cursor: pointer; border: none; transition: transform 0.1s; } 
    .fc-event:hover { transform: scale(1.01); z-index: 10; }
    
    /* Legend Badge */
    .badge-legend { font-size: 0.85rem; font-weight: 400; padding: 5px 10px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary fw-bold">
            <i class="bi bi-calendar3-range me-2"></i> 
            ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 
            {% if is_public_view %} <span class="text-muted fs-6 fw-normal">(‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞)</span>{% endif %}
        </h4>
        
        <div class="d-flex align-items-center gap-2">
            {% if not user.is_authenticated %}
                <a href="{% url 'login' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </a>
            {% else %}
                 <span class="text-muted small d-none d-md-block">
                    <i class="bi bi-hand-index-thumb"></i> ‡∏•‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                 </span>
            {% endif %}
        </div>
    </div>

    <div class="content-card shadow-sm border p-3 p-md-4">
        
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3 pb-3 border-bottom">
            <span class="badge badge-legend" style="background-color: #198754;">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
            <span class="badge badge-legend text-dark" style="background-color: #ffc107;">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á = ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
            <span class="badge badge-legend text-dark" style="background-color: #0dcaf0;">‡∏™‡∏µ‡∏ü‡πâ‡∏≤ = ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            <span class="badge badge-legend" style="background-color: #fd7e14;">‡∏™‡∏µ‡∏™‡πâ‡∏° = ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
            <span class="badge badge-legend" style="background-color: #dc3545;">‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
        </div>
        
        <div id="calendar"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() { 
    
    var calendarEl = document.getElementById('calendar');
    var isPublicView = '{{ is_public_view|yesno:"true,false" }}' === 'true';
    var isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};

    var calendar = new FullCalendar.Calendar(calendarEl, {
        
        initialView: 'dayGridMonth', 
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
        },
        
        // üñêÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Drag & Drop (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)
        editable: isAuthenticated, 
        droppable: isAuthenticated,
        
        // üì• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        events: {
            url: "{% url 'bookings_api' %}", 
            method: 'GET',
            extraParams: { public: isPublicView ? 'true' : 'false' },
            failure: function() { console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        },

        locale: 'th',
        firstDay: 0, 
        height: 'auto',
        dayMaxEvents: true,
        
        // üé® Logic ‡∏™‡∏µ
        eventDidMount: function(info) {
            var props = info.event.extendedProps;
            var now = new Date();
            var start = info.event.start;
            var end = info.event.end;
            var el = info.el;
            
            el.style.color = '#ffffff'; 

            if (props.status === 'PENDING') {
                el.style.backgroundColor = '#ffc107'; el.style.color = '#000';
            } else if (props.status === 'APPROVED') {
                if (now >= end) { el.style.backgroundColor = '#fd7e14'; }
                else if (now >= start && now < end) { el.style.backgroundColor = '#0dcaf0'; el.style.color = '#000'; }
                else { el.style.backgroundColor = '#198754'; }
            } else if (props.status === 'CANCELLED' || props.status === 'REJECTED') {
                el.style.backgroundColor = '#dc3545'; 
            }
        },
        
        // üñ±Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        eventClick: function(info) {
            window.location.href = "{% url 'booking_detail' 0 %}".replace('0', info.event.id);
        },

        // üñ±Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
        selectable: true,
        select: function(info) {
            if(!isAuthenticated) {
                if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô)')) {
                    window.location.href = "{% url 'login' %}";
                }
            } else {
                window.location.href = "{% url 'create_booking' all_rooms.0.id %}?start=" + info.startStr + "&end=" + info.endStr;
            }
        },

        // üöö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢ (‡∏¢‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤)
        eventDrop: function(info) {
            handleEventUpdate(info);
        },

        // ‚ÜîÔ∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡∏≠‡∏ö (‡∏¢‡∏∑‡∏î/‡∏´‡∏î‡πÄ‡∏ß‡∏•‡∏≤)
        eventResize: function(info) {
            handleEventUpdate(info);
        }
    });
    
    calendar.render();

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (AJAX) ---
    function handleEventUpdate(info) {
        if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            info.revert(); // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°
            return;
        }

        var event = info.event;
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
        fetch("{% url 'update_booking_time_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                booking_id: event.id,
                start_time: event.start.toISOString(),
                end_time: event.end ? event.end.toISOString() : event.start.toISOString()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)
            } else {
                alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + data.message);
                info.revert(); // ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            info.revert();
        });
    }
});
</script>
{% endblock %}