{% extends 'base.html' %}

{% block title %}ตารางเวลารวม - {{ block.super }}{% endblock %}

{% block extra_head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

<style>
    #calendar { max-width: 1200px; margin: 0 auto; }

    .fc .fc-button-primary { 
        background-color: #0d6efd; 
        border-color: #0d6efd; 
    }

    /* Event Style */
    .fc-event {
        border-radius: 5px;
        padding: 2px 4px;
        font-size: 0.85rem;
        white-space: normal;
    }

    .fc-event-title b {
        color: #0d6efd;
    }

    /* TimeGrid stacked view ปรับให้อ่านง่าย */
    .fc-timegrid-event {
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0"><i class="bi bi-calendar3 me-2"></i>ตารางเวลารวม</h1>
        <p class="text-muted mb-0">ภาพรวมการจองห้องประชุมทั้งหมด</p>
    </div>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-grid-fill me-1"></i> กลับสู่หน้าหลัก
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div id='calendar'></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        initialView: 'timeGridWeek',
        slotMinTime: '08:00:00',
        slotMaxTime: '19:00:00',
        events: "{% url 'api_bookings' %}", // ดึงข้อมูลการจองทั้งหมด

        eventDisplay: 'block',
        eventOverlap: false,
        slotEventOverlap: false,  // ป้องกัน Event ซ้อนทับ
        eventOrder: 'start',      // จัดเรียงตามเวลา
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        displayEventEnd: false,   // ลดการซ้อนเวลา
        displayEventTime: true,

        eventDidMount: function(info) {
            // แสดงชื่อห้อง + ชื่อ Event
            const roomName = info.event.extendedProps.room_name || '';
            const originalTitle = info.event.title;
            info.el.querySelector('.fc-event-title').innerHTML = `<b>${roomName}:</b> ${originalTitle}`;
        },

        eventClick: function(info) {
            // คลิก Event ไปปฏิทินห้องนั้น
            const roomId = info.event.extendedProps.room_id;
            if (roomId) {
                window.location.href = `/room/${roomId}/calendar/`;
            }
        }
    });

    calendar.render();
});
</script>
{% endblock %}
