{% extends 'base.html' %}
{% load static %}
{% block title %}ตารางห้อง {{ room.name }} - {{ block.super }}{% endblock %}
{% block page_title %}<i class="bi bi-door-open-fill me-2"></i>ตารางห้อง: {{ room.name }}{% endblock %}

{% block extra_head %}
<style>
    /* --- ลบ CSS Carousel ออก --- */
    /* .room-image-carousel img { ... } */
    #calendar { background-color: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,.04); margin-top: 1.5rem; }
    .fc-event { border: 1px solid transparent !important; padding: 2px 5px !important; font-size: 0.8rem !important; line-height: 1.3 !important; cursor: pointer !important; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .fc-event[data-status="APPROVED"] { background-color: var(--bs-success) !important; border-color: var(--bs-success) !important; color: white !important; }
    .fc-event[data-status="PENDING"] { background-color: var(--bs-warning) !important; border-color: var(--bs-warning) !important; color: black !important; }
    .fc-event[data-status="REJECTED"] { background-color: var(--bs-danger) !important; border-color: var(--bs-danger) !important; color: white !important; opacity: 0.75; }
    .fc-event[data-status="CANCELLED"] { background-color: #6c757d !important; border-color: #6c757d !important; color: white !important; opacity: 0.6; }
    .fc-event-main { white-space: normal; overflow: hidden; text-overflow: ellipsis; }
    .fc-event-time { margin-right: 5px; font-weight: bold; }
</style>
{% endblock %}

{% block content %}

{# --- [ลบ] ส่วนแสดงรูปภาพ Carousel ทั้งหมด --- #}
{# {% if room.image1 or room.image2 or room.image3 %} ... {% endif %} #}

{# --- แสดงข้อมูลห้องแทนรูปภาพ --- #}
<div class="card modern-card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="card-title">{{ room.name }}</h5>
        <p class="card-text mb-1">
            <span class="text-muted">อาคาร:</span> {{ room.building|default:"-" }} |
            <span class="text-muted">ชั้น:</span> {{ room.floor|default:"-" }} |
            <span class="text-muted">โซน:</span> {{ room.location|default:"-" }}
        </p>
        <p class="card-text mb-1"><i class="bi bi-people-fill me-1"></i><span class="text-muted">ความจุ:</span> {{ room.capacity }} คน</p>
        <p class="card-text mb-0"><i class="bi bi-tools me-1"></i><span class="text-muted">อุปกรณ์:</span> {{ room.equipment_in_room|default:"-"|linebreaksbr }}</p>
    </div>
</div>

{# --- ปฏิทิน --- #}
<div id="calendar"></div>

{# --- Modal --- #}
{% include 'partials/_booking_form_modal.html' %}

{% endblock %}

{% block extra_scripts %}
    {# block.super already includes jQuery, Bootstrap, Select2, FullCalendar, DAL JS #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const bookingModalElement = document.getElementById('bookingModal');
    const form = document.getElementById('bookingForm');
    const startTimeInput = document.getElementById('id_start_time');
    const endTimeInput = document.getElementById('id_end_time');
    const roomIdInput = form ? form.querySelector('input[name="room"]') : null;
    const modalTitleEl = bookingModalElement ? bookingModalElement.querySelector('.modal-title') : null;
    const participantsSelect = $('#id_participants');

    if (!calendarEl || !bookingModalElement || !form || !startTimeInput || !endTimeInput || !roomIdInput) {
        console.error("FATAL: Calendar, Modal, Form, or input elements not found!");
        if(calendarEl) calendarEl.innerHTML = "<div class='alert alert-danger'>❌ เกิดข้อผิดพลาดในการโหลดองค์ประกอบหน้าเว็บ</div>";
        return;
    }

    const bookingModal = new bootstrap.Modal(bookingModalElement);

    if (typeof FullCalendar === 'undefined') {
        calendarEl.innerHTML = "<div class='alert alert-danger'>❌ FullCalendar library ยังไม่โหลด!</div>"; return;
    }
    console.log("FullCalendar loaded.");

    const calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        initialView: 'timeGridWeek',
        locale: 'th',
        buttonText: { today: 'วันนี้', month: 'เดือน', week: 'สัปดาห์', day: 'วัน' },
        slotMinTime: '08:00:00',
        slotMaxTime: '19:00:00',
        allDaySlot: false,
        editable: {{ is_admin_user|yesno:"true,false" }},
        selectable: true,
        nowIndicator: true,
        events: "{% url 'api_bookings' %}?room_id={{ room.id }}",

        select: function(info) {
            form.reset();
            if (typeof $ !== 'undefined' && participantsSelect.data('select2')) {
                participantsSelect.val(null).trigger('change');
            }
            const localStart = new Date(info.start.getTime() - (info.start.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            const localEnd = new Date(info.end.getTime() - (info.end.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            startTimeInput.value = localStart;
            endTimeInput.value = localEnd;
            roomIdInput.value = '{{ room.id }}';
            if(modalTitleEl) modalTitleEl.textContent = 'จองห้อง: {{ room.name|escapejs }}';
            form.action = "{% url 'create_booking_for_room' room.id %}";
            bookingModal.show();
        },

        eventDidMount: function(info) {
            const props = info.event.extendedProps;
            info.el.setAttribute('data-status', props.status || '');
            const titleEl = info.el.querySelector('.fc-event-title') || info.el.querySelector('.fc-event-main');
            if (titleEl && props.booked_by_username) {
                 titleEl.innerHTML = `${info.event.title} <small>(${props.booked_by_username})</small>`;
            }
        },

        eventClick: function(info) { window.location.href = `/booking/${info.event.id}/`; },
        eventDrop: function(info) { handleEventUpdate(info); },
        eventResize: function(info) { handleEventUpdate(info); },
        loading: function(isLoading) { /* ... */ },
        eventSourceFailure: function(error) {
             console.error("Error fetching events:", error.message);
             if (!calendarEl.querySelector('.event-fetch-error')) {
                 calendarEl.insertAdjacentHTML('afterbegin', "<div class='alert alert-warning small py-1 px-2 event-fetch-error'>⚠ ไม่สามารถโหลดข้อมูลการจองได้</div>");
             }
         }
    });

    calendar.render();
    console.log("Calendar rendered.");

    function handleEventUpdate(info) {
        if (!{{ is_admin_user|yesno:"true,false" }}) { info.revert(); return; }
        const event = info.event;
        const updatedData = { booking_id: event.id, start_time: event.start.toISOString(), end_time: event.end ? event.end.toISOString() : event.start.toISOString() };
        if (!updatedData.end_time || updatedData.start_time >= updatedData.end_time) { alert("⚠ เวลาสิ้นสุดไม่ถูกต้อง"); info.revert(); return; }
        console.log("Submitting time update:", updatedData);
        fetch("{% url 'api_update_booking_time' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(updatedData)
        })
        .then(response => {
            if (!response.ok) { return response.json().then(errData => { throw new Error(errData.message || `Error (${response.status})`); }).catch(() => { throw new Error(`Error (${response.status})`); }); }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') { console.log("Update success:", data.message); }
            else { throw new Error(data.message || "Server error"); }
        })
        .catch(error => { console.error('Update Error:', error); alert("⚠ Update failed: " + error.message); info.revert(); });
    }

});
</script>
{% endblock %}