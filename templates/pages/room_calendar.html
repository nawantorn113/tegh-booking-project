{% extends 'base.html' %}
{% load static %}

{% block title %}ปฏิทินห้อง: {{ room.name }}{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_head %}
{{ form.media.css }}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />

<style>
    :root {
        --fc-border-color: #e9ecef;
        --fc-today-bg-color: #f8f9fa;
        --fc-button-active-bg-color: #4338ca;
        --fc-button-active-border-color: #4338ca;
    }
    .fc { font-family: 'Kanit', sans-serif; }
    .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 500; }
    .room-image { height: 250px; object-fit: cover; border-radius: 0.5rem; }
    #calendar { margin-top: 1.5rem; }
    #bookingFormContainer { display: none; }
    
    /* [แก้ไข] ทำให้ Select2 สวยงามใน Modal */
    .select2-container { z-index: 1056; } 
    .select2-container--bootstrap-5 .select2-selection {
        width: 100% !important;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">

    {# --- ส่วนแสดงรูปภาพและรายละเอียดห้อง --- #}
    <div class="content-card shadow-sm border p-3 p-md-4 mb-4">
        <div class="row">
            <div class="col-lg-6 mb-3 mb-lg-0">
                {% if room.image %}
                    <img src="{{ room.image.url }}" class="d-block w-100 room-image" alt="รูปห้อง">
                {% else %}
                    <div class="bg-light text-muted d-flex align-items-center justify-content-center room-image">ไม่มีรูปภาพตัวอย่าง</div>
                {% endif %}
            </div>
            <div class="col-lg-6">
                <h4 class="fw-bold text-primary">{{ room.name }}</h4>
                <p class="text-muted small mb-3">{{ room.location|default:"(ไม่ได้ระบุตำแหน่ง)" }}</p>
                <p class="mb-2"><i class="bi bi-people-fill me-2 text-muted"></i> <strong>ความจุ:</strong> {{ room.capacity }} คน</p>
                <p class="mb-2"><i class="bi bi-building me-2 text-muted"></i> <strong>อาคาร:</strong> {{ room.building|default:"-" }} (ชั้น {{ room.floor|default:"-" }})</p>
                <p class="mb-1"><i class="bi bi-tools me-2 text-muted"></i> <strong>อุปกรณ์:</strong></p>
                <div class="small text-muted ps-4 mt-1">
                    {{ room.equipment_in_room|default:"(ไม่มีข้อมูลอุปกรณ์ระบุ)"|linebreaksbr }}
                </div>
            </div>
        </div>
    </div>

    {# --- ส่วนปฏิทินการจอง --- #}
    <div class="content-card shadow-sm border p-3 p-md-4">
        <h5 class="mb-0">ตารางการจองห้องประชุม (คลิกที่ช่วงเวลาว่างเพื่อจอง)</h5>
        <div id="calendar"></div>
    </div>
</div>

{# --- โค้ดที่ซ่อนไว้สำหรับ Modal และ Form (จำเป็น) --- #}
<div id="bookingFormContainer" style="display:none;">
    <form id="hiddenBookingForm" action="{% url 'create_booking' room.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
    </form>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">จองห้อง: {{ room.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBookingBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" form="hiddenBookingForm">ยืนยันการจอง</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
{{ form.media.js }}

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
window.onload = function() {
    
    // (ตรวจสอบไลบรารี)
    if (typeof FullCalendar === 'undefined' || typeof bootstrap === 'undefined' || typeof $ === 'undefined' || typeof yl === 'undefined') {
        console.error("Required JS libraries not loaded (jQuery, Bootstrap, FullCalendar, or DAL/yl).");
        document.getElementById('calendar').innerHTML = '<div class="alert alert-danger">เกิดข้อผิดพลาด: โหลดไลบรารีไม่สำเร็จ กรุณาล้างแคช (Ctrl+Shift+R)</div>';
        return; 
    }
    
    var calendarEl = document.getElementById('calendar');
    var hiddenForm = document.getElementById('hiddenBookingForm');
    var modalBody = document.getElementById('modalBookingBody');
    var startTimeField = document.getElementById('id_start_time');
    var endTimeField = document.getElementById('id_end_time');
    var bookingModalEl = document.getElementById('bookingModal'); 
    var bookingModal = new bootstrap.Modal(bookingModalEl);
    
    if (!startTimeField || !endTimeField) {
        console.error("ไม่พบช่อง input #id_start_time หรือ #id_end_time");
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek', 
        locale: 'th',
        firstDay: 0, 
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
        },
        buttonText: { today: 'วันนี้', month: 'เดือน', week: 'สัปดาห์', day: 'วัน' },
        
        allDaySlot: false, 
        slotMinTime: '07:30:00', 
        slotMaxTime: '18:00:00',
        businessHours: {
            daysOfWeek: [ 0, 1, 2, 3, 4, 5, 6 ],
            startTime: '08:00',
            endTime: '18:00',
        },
        
        selectable: true, 
        selectMirror: true, 
        nowIndicator: true, 
        
        selectAllow: function(selectInfo) {
            var now = new Date();
            if (selectInfo.start < now) { return false; }
            return true;
        },

        select: function(info) {
            var now = new Date();
            if (info.start < now) {
                alert("ไม่สามารถจองย้อนหลังได้");
                calendar.unselect();
                return;
            }

            if (info.view.type.includes('dayGrid')) { 
                info.start.setHours(8, 0, 0, 0); 
                var end = new Date(info.end.getTime()); 
                if (info.end.getDate() !== info.start.getDate()) {
                    end.setDate(end.getDate() - 1); 
                } 
                end.setHours(18, 0, 0, 0);
                info.end = end;
            }
            
            var startStr = new Date(info.start.getTime() - (info.start.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
            var endStr = new Date(info.end.getTime() - (info.end.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
            
            modalBody.appendChild(hiddenForm); 
            startTimeField.value = startStr;
            endTimeField.value = endStr;
            
            // [แก้ไข] เราต้อง "บังคับ" ให้ DAL (yl) ทำงานกับ Select2 ที่อยู่ใน Modal
            if (typeof yl !== 'undefined' && yl.register) {
                var $participants = $(modalBody).find('#id_participants');
                if ($participants.length) {
                    if ($participants.hasClass('select2-hidden-accessible')) {
                        $participants.select2('destroy');
                    }
                    yl.register($participants, {
                        dropdownParent: $('#bookingModal')
                    });
                }
            }

            bookingModal.show();
        },
        
        events: "{% url 'bookings_api' %}?room_id={{ room.id }}",

        eventDataTransform: function(eventData) {
            let props = eventData.extendedProps || {};
            var now = new Date();
            var eventStart = new Date(eventData.start);
            var eventEnd = new Date(eventData.end);

            if (props.status === 'PENDING') {
                eventData.backgroundColor = '#ffc107'; 
                eventData.borderColor = '#ffc107';
                eventData.title = `[รออนุมัติ] ${eventData.title}`;
            } else if (props.status === 'APPROVED') {
                if (now >= eventStart && now < eventEnd) {
                    eventData.backgroundColor = '#dc3545'; 
                    eventData.borderColor = '#dc3545';
                    eventData.title = `[กำลังใช้งาน] ${eventData.title}`;
                } else {
                    eventData.backgroundColor = '#198754'; 
                    eventData.borderColor = '#198754';
                    eventData.title = `[จองแล้ว] ${eventData.title}`;
                }
            } else if (eventData.display !== 'background') {
                eventData.display = 'none';
            }
            return eventData;
        },

        eventClick: function(info) {
            if (info.event.display === 'background') { return false; }
            window.location.href = "{% url 'booking_detail' 0 %}".replace('0', info.event.id);
        },
        
        viewDidMount: function() {
            bookingModalEl.addEventListener('hidden.bs.modal', function () {
                document.getElementById('bookingFormContainer').appendChild(hiddenForm);
                if ($.fn.select2) {
                    $('#id_participants').select2('destroy');
                }
            });
        }
    });
    
    calendar.render();
};
</script>
{% endblock %}