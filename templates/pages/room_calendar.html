{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_head %}
    {{ form.media.css }}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        /* ... (CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... ‡∏ú‡∏°‡∏à‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ... */
        :root {
            --fc-border-color: #e9ecef;
            --fc-today-bg-color: #f8f9fa;
        }
        .fc { font-family: 'Kanit', sans-serif; }
        .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 500; }
        #calendar { margin-top: 1.5rem; }
        .modal-header { padding-bottom: 5px !important; }
        .modal-body { padding-top: 10px !important; }
        
        /* üí° [FIX] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ CSS ‡∏ó‡∏µ‡πà "‡πÅ‡∏£‡∏á‡∏Å‡∏ß‡πà‡∏≤" ‡∏à‡∏≤‡∏Å base.html
           (‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î 3 ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <style> ‡∏Ç‡∏≠‡∏á base.html
           ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö)
        */
        .select2-selection__rendered {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
        }
        .select2-selection__choice {
            margin-top: 0 !important;
            margin-bottom: 2px !important;
        }
        .select2-search--inline {
            float: none !important;
            flex-grow: 1 !important;
        }
        
        .fc-event.event-pending {
            background-color: #f39c12 !important; 
            border-color: #f39c12 !important;
        }
        .fc-daygrid-day-frame {
            position: relative; 
            min-height: 100px; 
        }
        .fc-day-available-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.25rem;
            color: #d0d0d0; 
            font-weight: 600;
            z-index: 1; 
            pointer-events: none; 
        }
        .fc-daygrid-event {
            z-index: 2 !important; 
        }
    </style>
{% endblock %}


{% block content %}
    <div class="py-4"> 
        <div class="content-card shadow-sm border p-3 p-md-4 mb-4">
            <div class="row g-4">
                <div class="col-lg-5">
                    {% if room.image %}
                        <img src="{{ room.image.url }}" class="d-block w-100" style="height: 250px; object-fit: cover; border-radius: 0.5rem;" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á {{ room.name }}">
                    {% else %}
                        <div class="bg-light text-muted d-flex align-items-center justify-content-center" style="height: 250px; border-radius: 0.5rem;">
                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col-lg-7">
                    <h4 class="fw-bold text-primary mb-2">{{ room.name }}</h4> 
                    <p class="text-muted small mb-3">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        {{ room.location|default:"(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)" }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-people-fill me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {{ room.capacity }} ‡∏Ñ‡∏ô
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-building me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> {{ room.building|default:"-" }} (‡∏ä‡∏±‡πâ‡∏ô {{ room.floor|default:"-" }})
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-tools me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong>
                        </li>
                    </ul>
                    <div class="small text-muted ps-4" style="margin-left: 1.25em;">
                        {{ room.equipment_in_room|default:"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"|linebreaksbr }}
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card shadow-sm border p-3 p-md-4">
            <h5 class="mb-0">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</h5>
            <div id="calendar"></div>
        </div>
    </div>

    <div id="bookingFormContainer" style="display:none;">
        <form id="hiddenBookingForm" action="{% url 'create_booking' room.id %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
        </form>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBookingBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" id="submitBookingBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block extra_scripts %} 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/th.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    {{ form.media.js }}

    <script>
    // üí° [FIX] 5. ‡∏´‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô $(document).ready()
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ jQuery ‡∏à‡∏≤‡∏Å base.html ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    $(document).ready(function() {
        
        const calendarEl = document.getElementById('calendar');
        const hiddenForm = document.getElementById('hiddenBookingForm');
        const modalBody = document.getElementById('modalBookingBody');
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const bookingModalEl = document.getElementById('bookingModal');
        const ROOM_CAPACITY = {{ room.capacity|default:1 }}; 

        // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡πÅ‡∏Æ‡πá‡∏Ñ" '‡∏ß‡πà‡∏≤‡∏á' ... ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß)
        function addAvailableText(view) {
            setTimeout(function() { 
                document.querySelectorAll('.fc-day-available-text').forEach(el => el.remove());
                if (view.type === 'dayGridMonth') {
                    let dayCells = document.querySelectorAll('.fc-daygrid-day');
                    dayCells.forEach(function(dayCell) {
                        let eventElements = dayCell.querySelectorAll('.fc-event'); 
                        let isPast = dayCell.classList.contains('fc-day-past');
                        let isOtherMonth = dayCell.classList.contains('fc-day-other');
                        if (eventElements.length === 0 && !isPast && !isOtherMonth) {
                            let availableEl = document.createElement('div');
                            availableEl.className = 'fc-day-available-text';
                            availableEl.innerHTML = '‡∏ß‡πà‡∏≤‡∏á';
                            let dayFrame = dayCell.querySelector('.fc-daygrid-day-frame');
                            if (dayFrame) {
                                dayFrame.appendChild(availableEl);
                            }
                        }
                    });
                }
            }, 100); 
        }
        
        // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" (‡πÅ‡∏Å‡πâ "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô")... ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        function formatDateTimeLocal(date, defaultHour = null, defaultMinute = null) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = (defaultHour !== null ? defaultHour : date.getHours()).toString().padStart(2, '0');
            const minutes = (defaultMinute !== null ? defaultMinute : date.getMinutes()).toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }


        const calendar = new FullCalendar.Calendar(calendarEl, {
            
            initialView: 'dayGridMonth', 
            locale: 'th',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay' 
            },
            buttonText: { today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', day: '‡∏ß‡∏±‡∏ô' },
            selectable: true,
            editable: false,
            events: "{% url 'bookings_api' %}?room_id={{ room.id }}",

            // (‡πÇ‡∏Ñ‡πâ‡∏î "‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ... ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            eventDidMount: function(info) {
                if (info.event.extendedProps.status === 'PENDING') {
                    info.el.classList.add('event-pending');
                }
            },

            // (‡πÇ‡∏Ñ‡πâ‡∏î "‡πÇ‡∏ä‡∏ß‡πå '‡∏ß‡πà‡∏≤‡∏á'" ... ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            datesSet: function(info) {
                addAvailableText(info.view);
            },
            loading: function(isLoading) {
                if (!isLoading) { 
                    addAvailableText(this.view); 
                }
            },

            // üí° [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] (Requirement 2) "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô"
            select: function(info) {
                
                let startStr, endStr;
                
                if (info.allDay) {
                    startStr = formatDateTimeLocal(info.start, 8, 30); 
                    endStr = formatDateTimeLocal(info.start, 9, 30); 
                } else {
                    startStr = formatDateTimeLocal(info.start);
                    endStr = formatDateTimeLocal(info.end);
                }
                
                // üí° [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] "‡∏•‡πâ‡∏≤‡∏á" (Reset) ... "‡∏Å‡πà‡∏≠‡∏ô" ... "‡∏¢‡∏±‡∏î" (Set Value)
                hiddenForm.reset(); 

                document.getElementById('id_start_time').value = startStr;
                document.getElementById('id_end_time').value = endStr;
                
                modalBody.appendChild(hiddenForm);
                
                // üí°üí°üí° [FIX 6] "‡∏ó‡∏≥‡∏•‡∏≤‡∏¢" ‡πÅ‡∏•‡∏∞ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà" üí°üí°üí°
                // (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• 100% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal)
                
                var $participantsSelect = $('#id_participants');

                // 1. ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Select2 ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ó‡∏µ‡πà DAL ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤)
                if ($participantsSelect.data('select2')) {
                    $participantsSelect.select2('destroy');
                }

                // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Select2 ‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Modal
                $participantsSelect.select2({
                    theme: 'bootstrap-5',
                    language: 'th',
                    width: '100%',
                    dropdownParent: $('#bookingModal .modal-content') // üí° ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
                });
                
                bookingModal.show();
            },
            
            // (‡πÇ‡∏Ñ‡πâ‡∏î "‡∏Ñ‡∏•‡∏¥‡∏Å Event" (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ... ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            eventClick: function(info) {
                info.jsEvent.preventDefault(); 
                let bookingId = info.event.id;
                let detailUrl = `/booking/detail/${bookingId}/`; 
                window.location.href = detailUrl;
            }
        });

        calendar.render(); 

        // üí° [FIX] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ "‡∏ó‡∏≥‡∏•‡∏≤‡∏¢" Select2 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Modal ‡∏õ‡∏¥‡∏î
        bookingModalEl.addEventListener('hidden.bs.modal', function () {
            var $participantsSelect = $('#id_participants');
            if ($participantsSelect.data('select2')) {
                $participantsSelect.select2('destroy');
            }
            // ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏±‡∏ö
            document.getElementById('bookingFormContainer').appendChild(hiddenForm);
        });
        
        // (‡πÇ‡∏Ñ‡πâ‡∏î 'submitBookingBtn' ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        document.getElementById('submitBookingBtn').addEventListener('click', function(event) {
            
            const participantCountEl = document.getElementById('id_participant_count');
            let participantCountVal = 1; 
            
            if (participantCountEl) {
                participantCountVal = parseInt(participantCountEl.value) || 1;
            }

            if (participantCountVal > ROOM_CAPACITY) {
                alert(`‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (${participantCountVal} ‡∏Ñ‡∏ô) ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á (${ROOM_CAPACITY} ‡∏Ñ‡∏ô)! \n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•`);
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            hiddenForm.submit();
        });
    });
    </script>

{% endblock %}