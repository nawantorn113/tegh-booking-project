{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<style>
  .fc-event.vacant { background-color: #28a745; }
  .fc-event.booked { background-color: #007bff; }
  .fc-event.pending { background-color: #ffc107; }
  .room-card { border: 1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:8px; display:flex; gap:10px; }
  .room-card img { width:120px; height:80px; object-fit:cover; border-radius:5px; }

  /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal */
  .modal {
    display: none; position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fefefe; margin: 10% auto; padding: 20px;
    border: 1px solid #888; width: 60%; border-radius: 8px;
  }
  .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

</style>
{% endblock %}


{% block content %}

<div class="room-card">
  {% if room.image %}
    <img src="{{ room.image.url }}" alt="Room Image">
  {% else %}
    <img src="{% static 'images/default_room.png' %}" alt="No Image">
  {% endif %}
  <div>
    <p><strong>{{ room.name }}</strong></p>
    <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: {{ room.capacity }} ‡∏Ñ‡∏ô</p>
    <p>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: {{ room.equipment_in_room|linebreaksbr }}</p>
  </div>
</div>

<div id='calendar'></div>


<div id="bookingModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h4>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h4>
    <p>‡∏´‡πâ‡∏≠‡∏á: <strong>{{ room.name }}</strong></p>
    
    <form action="{% url 'create_booking_for_room' room.id %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group" style="display:none;">
            {{ form.room.label_tag }}
            {{ form.room }}
        </div>
        <div class="form-group">
            {{ form.title.label_tag }}
            {{ form.title }}
        </div>
        <div class="form-group">
            {{ form.start_time.label_tag }}
            {{ form.start_time }}
        </div>
        <div class="form-group">
            {{ form.end_time.label_tag }}
            {{ form.end_time }}
        </div>
        <div class="form-group">
            {{ form.participant_count.label_tag }}
            {{ form.participant_count }}
        </div>
        <div class="form-group">
            {{ form.participants.label_tag }}
            {{ form.participants }}
        </div>
        
        <br>
        <button type="submit" class="btn btn-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    </form>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let calendarEl = document.getElementById('calendar');
  
  // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ---
  let modal = document.getElementById("bookingModal");
  let closeModalBtn = document.getElementById("closeModal");
  
  closeModalBtn.onclick = function() {
    modal.style.display = "none";
  }
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
  // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ---


  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    selectable: true,
    selectMirror: true,
    timeZone: 'Asia/Bangkok',

    // --- üü¢ START: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ üü¢ ---
    slotDuration: '01:00:00',  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏∞ 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    slotMinTime: '08:00:00',   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 8 ‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤
    slotMaxTime: '18:00:00',   // ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 6 ‡πÇ‡∏°‡∏á‡πÄ‡∏¢‡πá‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á 17:00-18:00 ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
    // --- üü¢ END: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ üü¢ ---

    events: "{% url 'api_bookings' %}?room_id={{ room.id }}",
    eventClassNames: function(info) {
      if(info.event.extendedProps.status === 'APPROVED') return ['booked'];
      else if(info.event.extendedProps.status === 'PENDING') return ['pending'];
      else return ['vacant'];
    },
    
    // --- 'select' (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á) ---
    select: function(info) {
      let now = new Date();
      let start = info.start;
      let end = info.end;

      if(start < now){
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");
        calendar.unselect(); 
        return;
      }

      // --- ‚ùå ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 8:00-18:00 ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß) ‚ùå ---
      /*
      if(start.getHours() < 8 || end.getHours() > 18 || ...){
        alert("‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ 08:00 - 18:00");
        calendar.unselect();
        return;
      }
      */
      // --- --------------------------------------------------------- ---

      for(let ev of calendar.getEvents()){
        if( (start < ev.end) && (end > ev.start) && 
            (ev.extendedProps.status === 'APPROVED' || ev.extendedProps.status === 'PENDING') 
        ){
          alert("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
          calendar.unselect();
          return;
        }
      }

      // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ field ‡πÉ‡∏ô Form Modal (‡πÉ‡∏ä‡πâ .slice(0, 16) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      document.querySelector("#bookingModal [name='room']").value = {{ room.id }};
      document.querySelector("#bookingModal [name='start_time']").value = info.startStr.slice(0, 16);
      document.querySelector("#bookingModal [name='end_time']").value = info.endStr.slice(0, 16);
      document.querySelector("#bookingModal [name='title']").value = ""; 
      document.querySelector("#bookingModal [name='participant_count']").value = 1; 

      // 2. ‡πÅ‡∏™‡∏î‡∏á Modal
      modal.style.display = "block";
      calendar.unselect();
    },
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î 'select' ---


    // --- 'eventClick' (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ---
    eventClick: function(info){
      
      if(info.event.extendedProps.user_id == {{ request.user.id }}){
        
        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
        if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
          let urlTemplate = "{% url 'delete_booking_api' 0 %}";
          let finalUrl = urlTemplate.replace('0', info.event.id);

          fetch(finalUrl, {
            method: "POST",
            headers: { 
              "X-CSRFToken": "{{ csrf_token }}",
              "Accept": "application/json"
            },
          })
          .then(res => res.json())
          .then(data => {
            if(data.success){ 
              alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
              info.event.remove(); 
            } else { 
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.error); 
            }
          })
          .catch(err => {
            console.error(err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
          });
        }
      } else {
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
        if(confirm("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
            let detailUrlTemplate = "{% url 'booking_detail' 0 %}";
            let detailFinalUrl = detailUrlTemplate.replace('0', info.event.id);
            window.open(detailFinalUrl, '_blank'); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
        }
      }
    },
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î 'eventClick' ---

    editable: false,
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' }
  });
  calendar.render();
});
</script>
{% endblock %}