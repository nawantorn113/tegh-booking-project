{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_head %}
{{ form.media.css }}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    /* ... (CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞) ... */
    :root {
        --fc-border-color: #e9ecef;
        --fc-today-bg-color: #f8f9fa;
    }
    .fc { font-family: 'Kanit', sans-serif; }
    .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 500; }
    #calendar { margin-top: 1.5rem; }

    /* (Modal spacing fix) */
    .modal-header { padding-bottom: 5px !important; }
    .modal-body { padding-top: 10px !important; }
    #bookingFormContainer p { margin-bottom: 0.4rem !important; }

    /* (Select2 fix) */
    .select2-container {
        min-width: 100% !important;
        width: 100% !important;
        display: block !important;
        z-index: 1056;
    }
    
    /* (‡∏™‡πÑ‡∏ï‡∏•‡πå "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") */
    .fc-event.event-pending {
        background-color: #f39c12 !important; 
        border-color: #f39c12 !important;
    }

    /* (CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ß‡πà‡∏≤‡∏á") */
    .fc-daygrid-day-frame {
        position: relative; 
        min-height: 100px; 
    }
    .fc-day-available-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.25rem;
        color: #d0d0d0; 
        font-weight: 600;
        z-index: 1; 
        pointer-events: none; 
    }
    .fc-daygrid-event {
        z-index: 2 !important; 
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">
    <div class="content-card shadow-sm border p-3 p-md-4 mb-4">
        <div class="row g-4">
            <div class="col-lg-5">
                {% if room.image %}
                    <img src="{{ room.image.url }}" class="d-block w-100" style="height: 250px; object-fit: cover; border-radius: 0.5rem;" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á {{ room.name }}">
                {% else %}
                    <div class="bg-light text-muted d-flex align-items-center justify-content-center" style="height: 250px; border-radius: 0.5rem;">
                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                    </div>
                {% endif %}
            </div>
            <div class="col-lg-7">
                <h4 class="fw-bold text-primary mb-2">{{ room.name }}</h4> 
                <p class="text-muted small mb-3">
                    <i class="bi bi-geo-alt-fill me-1"></i>
                    {{ room.location|default:"(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)" }}
                </p>
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-people-fill me-2 text-muted" style="width: 1.25em;"></i>
                        <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {{ room.capacity }} ‡∏Ñ‡∏ô
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-building me-2 text-muted" style="width: 1.25em;"></i>
                        <strong>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> {{ room.building|default:"-" }} (‡∏ä‡∏±‡πâ‡∏ô {{ room.floor|default:"-" }})
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-tools me-2 text-muted" style="width: 1.25em;"></i>
                        <strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong>
                    </li>
                </ul>
                <div class="small text-muted ps-4" style="margin-left: 1.25em;">
                    {{ room.equipment_in_room|default:"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"|linebreaksbr }}
                </div>
            </div>
        </div>
    </div>

    <div class="content-card shadow-sm border p-3 p-md-4">
        <h5 class="mb-0">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</h5>
        <div id="calendar"></div>
    </div>
</div>

<div id="bookingFormContainer" style="display:none;">
    <form id="hiddenBookingForm" action="{% url 'create_booking' room.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
    </form>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBookingBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn btn-primary" form="hiddenBookingForm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %} 
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/th.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
{{ form.media.js }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const calendarEl = document.getElementById('calendar');
    const hiddenForm = document.getElementById('hiddenBookingForm');
    const modalBody = document.getElementById('modalBookingBody');
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

    // üí° [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡πÅ‡∏Æ‡πá‡∏Ñ" ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ß‡πà‡∏≤‡∏á" (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤)
    function addAvailableText(view) {
        
        // "‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" 100ms... ‡∏£‡∏≠‡πÉ‡∏´‡πâ "‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß" (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô) ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(function() { 
            
            // (1. ‡∏•‡πâ‡∏≤‡∏á "‡∏ß‡πà‡∏≤‡∏á" ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á)
            document.querySelectorAll('.fc-day-available-text').forEach(el => el.remove());

            if (view.type === 'dayGridMonth') {
                let dayCells = document.querySelectorAll('.fc-daygrid-day');
                
                dayCells.forEach(function(dayCell) {
                    // (2. ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ Event ‡πÅ‡∏õ‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤ *‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å* ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
                    let eventElements = dayCell.querySelectorAll('.fc-event'); 
                    
                    let isPast = dayCell.classList.contains('fc-day-past');
                    let isOtherMonth = dayCell.classList.contains('fc-day-other');

                    // (3. ‡∏ñ‡πâ‡∏≤ "‡πÑ‡∏°‡πà‡∏°‡∏µ Event" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏î‡∏µ‡∏ï" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"... ‡∏¢‡∏±‡∏î "‡∏ß‡πà‡∏≤‡∏á"!)
                    if (eventElements.length === 0 && !isPast && !isOtherMonth) {
                        let availableEl = document.createElement('div');
                        availableEl.className = 'fc-day-available-text';
                        availableEl.innerHTML = '‡∏ß‡πà‡∏≤‡∏á';
                        
                        let dayFrame = dayCell.querySelector('.fc-daygrid-day-frame');
                        if (dayFrame) {
                            dayFrame.appendChild(availableEl);
                        }
                    }
                });
            }
        }, 100); // üëà (‡∏´‡∏ô‡πà‡∏ß‡∏á 100ms... ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏ß‡πà‡∏≤ 1ms 555)
    }


    const calendar = new FullCalendar.Calendar(calendarEl, {
        
        initialView: 'dayGridMonth', 
        locale: 'th',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
        },
        buttonText: { today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', day: '‡∏ß‡∏±‡∏ô' },
        selectable: true,
        editable: false,
        events: "{% url 'bookings_api' %}?room_id={{ room.id }}",

        // (‡πÇ‡∏Ñ‡πâ‡∏î "‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        eventDidMount: function(info) {
            let event = info.event;
            let status = event.extendedProps.status;
            let titleEl = info.el.querySelector('.fc-event-title');

            if (status === 'PENDING') {
                info.el.classList.add('event-pending');
                if (titleEl) {
                    titleEl.innerHTML = event.title + ' <strong class="text-white">(‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</strong>';
                }
            }
            else if (status === 'APPROVED') {
                if (titleEl) {
                    titleEl.innerHTML = event.title + ' <span style="opacity: 0.8;">(‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</span>';
                }
            }
        },

        // üí° [‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà 2] "‡πÇ‡∏ä‡∏ß‡πå '‡∏ß‡πà‡∏≤‡∏á'" (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        datesSet: function(info) {
            addAvailableText(info.view);
        },
        
        // üí° [‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà 3] "‡πÇ‡∏ä‡∏ß‡πå '‡∏ß‡πà‡∏≤‡∏á'" (‡πÄ‡∏°‡∏∑‡πà‡∏≠ Event ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à)
        loading: function(isLoading) {
            if (!isLoading) { 
                addAvailableText(calendar.view);
            }
        },

        // (‡πÇ‡∏Ñ‡πâ‡∏î "‡∏Å‡∏î‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ" ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        select: function(info) {
            const startStr = new Date(info.start.getTime() - (info.start.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
            const endStr = new Date(info.end.getTime() - (info.end.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
            document.getElementById('id_start_time').value = startStr;
            document.getElementById('id_end_time').value = endStr;
            
            hiddenForm.reset(); 
            modalBody.appendChild(hiddenForm);
            bookingModal.show();
        }
    });

    calendar.render();

    // (‡πÇ‡∏Ñ‡πâ‡∏î 'hidden.bs.modal' ‡πÄ‡∏î‡∏¥‡∏°)
    document.getElementById('bookingModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('bookingFormContainer').appendChild(hiddenForm);
    });
});
</script>

{% endblock %}