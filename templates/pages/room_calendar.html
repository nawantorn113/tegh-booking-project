{% extends 'base.html' %}
{% block title %}{{ room.name }} - Calendar{% endblock %}

{% block extra_head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
<style>
    #calendar { max-width: 1100px; margin: 0 auto; }
    .fc .fc-button-primary { background-color: #0d6efd; border-color: #0d6efd; }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm mb-3"><i class="bi bi-arrow-left"></i> กลับไปหน้าหลัก</a>
<h1 class="mb-1">ตารางการใช้ห้อง: {{ room.name }}</h1>
<p class="text-muted mb-4">{{ room.location }}</p>

<div id='calendar-container' class="bg-white p-3 rounded shadow-sm">
    <div id='calendar'></div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">สร้างการจองสำหรับห้อง {{ room.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bookingForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="room" value="{{ room.id }}">
                    <div class="mb-3"><label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>{{ form.title }}</div>
                    <div class="row">
                        <div class="col-6 mb-3"><label for="{{ form.start_time.id_for_label }}" class="form-label">{{ form.start_time.label }}</label>{{ form.start_time }}</div>
                        <div class="col-6 mb-3"><label for="{{ form.end_time.id_for_label }}" class="form-label">{{ form.end_time.label }}</label>{{ form.end_time }}</div>
                    </div>
                    <div class="mb-3"><label for="{{ form.chairman.id_for_label }}" class="form-label">{{ form.chairman.label }}</label>{{ form.chairman }}</div>
                    <div class="mb-3"><label for="{{ form.participant_count.id_for_label }}" class="form-label">{{ form.participant_count.label }}</label>{{ form.participant_count }}</div>
                    <div class="mb-3"><label for="{{ form.additional_notes.id_for_label }}" class="form-label">{{ form.additional_notes.label }}</label>{{ form.additional_notes }}</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">ยืนยันการจอง</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const bookingForm = document.getElementById('bookingForm');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            initialView: 'timeGridWeek',
            slotMinTime: '08:00:00',
            slotMaxTime: '18:00:00',
            selectable: true,
            events: `/api/bookings/?room_id={{ room.id }}`, // ดึงข้อมูลเฉพาะห้องนี้
            select: function(info) {
                const formatDateTimeLocal = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

                document.getElementById('{{ form.start_time.id_for_label }}').value = formatDateTimeLocal(info.start);
                document.getElementById('{{ form.end_time.id_for_label }}').value = formatDateTimeLocal(info.end);

                bookingForm.action = `{% url 'create_booking_for_room' room.id %}`;

                bookingModal.show();
                calendar.unselect();
            },
            eventClick: function(info) {
                alert('การจอง: ' + info.event.title);
            }
        });
        calendar.render();
    });
</script>
{% endblock %}