{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_head %}
    {{ form.media.css }}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        :root { --fc-border-color: #e5e7eb; --fc-today-bg-color: #f8fafc; }
        .fc { font-family: 'Kanit', sans-serif; }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô */
        .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .fc .fc-button-primary { 
            background-color: #fff; border-color: #cbd5e1; color: #475569; 
            font-weight: 500; box-shadow: none !important;
        }
        .fc .fc-button-primary:hover { background-color: #f1f5f9; color: #1e293b; }
        .fc .fc-button-primary:not(:disabled).fc-button-active { 
            background-color: #3b82f6; border-color: #3b82f6; color: white; 
        }

        /* Event Styling */
        .fc-event { border: none; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .fc-event.event-pending { background-color: #f59e0b !important; border-left: 3px solid #b45309 !important; }
        .fc-event.event-approved { background-color: #10b981 !important; border-left: 3px solid #047857 !important; }
        .fc-event.event-maintenance { background-color: #64748b !important; border-left: 3px solid #334155 !important; }

        /* üì± Fix for Mobile (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô) */
        @media (max-width: 768px) {
            /* 1. ‡∏à‡∏±‡∏î Toolbar ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            .fc .fc-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            /* 2. ‡∏à‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%; 
            }
            /* 3. ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
            .fc .fc-toolbar-title { font-size: 1.1rem; }
            
            /* 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .fc-timegrid-slot { height: 3em !important; } 
        }
    </style>
{% endblock %}

{% block content %}
    <div class="py-3"> 
        <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
            <div class="row g-0">
                <div class="col-md-4 position-relative" style="min-height: 200px;">
                    {% if room.image %}
                        <img src="{{ room.image.url }}" class="w-100 h-100 object-fit-cover position-absolute top-0 start-0" alt="{{ room.name }}">
                    {% else %}
                        <div class="bg-light w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                            <i class="bi bi-image fs-1 opacity-25"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h3 class="fw-bold text-dark mb-0">{{ room.name }}</h3>
                            <span class="badge bg-primary rounded-pill">‡∏ä‡∏±‡πâ‡∏ô {{ room.floor|default:"-" }}</span>
                        </div>
                        <p class="text-muted small mb-3"><i class="bi bi-geo-alt-fill me-1"></i> {{ room.location|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" }}</p>
                        
                        <div class="d-flex gap-3 mb-3">
                            <div class="d-flex align-items-center text-secondary small">
                                <i class="bi bi-people-fill fs-5 me-2"></i>
                                <div><span class="d-block fw-bold text-dark">{{ room.capacity }}</span> ‡∏Ñ‡∏ô</div>
                            </div>
                            <div class="vr"></div>
                            <div class="d-flex align-items-center text-secondary small">
                                <i class="bi bi-building fs-5 me-2"></i>
                                <div><span class="d-block fw-bold text-dark">{{ room.building|default:"-" }}</span> ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                            </div>
                        </div>

                        {% if room.equipment_in_room %}
                        <div class="bg-light rounded-3 p-2 small text-muted">
                            <i class="bi bi-tools me-2"></i>{{ room.equipment_in_room }}
                        </div>
                        {% endif %}
                        
                        <div class="d-block d-md-none mt-3">
                            <button class="btn btn-primary w-100 rounded-pill fw-bold shadow-sm" onclick="prepareBookingModal()">
                                <i class="bi bi-plus-lg me-1"></i> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 p-3">
            <div class="alert alert-light border-0 d-flex align-items-center mb-3" role="alert">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <small class="text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</small>
            </div>
            <div id="calendar"></div>
        </div>
    </div>

    <div id="bookingFormContainer" class="d-none">
        <form id="hiddenBookingForm" action="{% url 'create_booking' room.id %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
        </form>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold">üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3" id="modalBookingBody">
                    </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4 shadow-sm" id="submitBookingBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %} 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    {{ form.media.js }}

    <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô)
    function prepareBookingModal(startStr = null, endStr = null) {
        const hiddenForm = document.getElementById('hiddenBookingForm');
        const modalBody = document.getElementById('modalBookingBody');
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        
        // 1. ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Modal
        if (!modalBody.contains(hiddenForm)) {
            modalBody.appendChild(hiddenForm);
        }
        hiddenForm.reset(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤

        // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤
        if (startStr && endStr) {
            document.getElementById('id_start_time').value = startStr;
            document.getElementById('id_end_time').value = endStr;
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á‡πÄ‡∏â‡∏¢‡πÜ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            // (Logic ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        }

        // 3. Re-init Select2 (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Modal)
        const $participantsSelect = $('#id_participants');
        if ($participantsSelect.data('select2')) { $participantsSelect.select2('destroy'); }
        $participantsSelect.select2({
            theme: 'bootstrap-5', language: 'th', width: '100%',
            dropdownParent: $('#bookingModal .modal-content')
        });

        bookingModal.show();
    }

    function formatDateTimeLocal(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    $(document).ready(function() {
        const calendarEl = document.getElementById('calendar');
        const bookingModalEl = document.getElementById('bookingModal');
        const hiddenForm = document.getElementById('hiddenBookingForm');
        const ROOM_CAPACITY = {{ room.capacity|default:1 }}; 

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const isMobile = window.innerWidth < 768;

        const calendar = new FullCalendar.Calendar(calendarEl, {
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (timeGridDay) ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (dayGridMonth)
            initialView: isMobile ? 'timeGridDay' : 'dayGridMonth',
            locale: 'th',
            
            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
            headerToolbar: {
                left: isMobile ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: isMobile ? 'timeGridDay,listWeek' : 'dayGridMonth,timeGridWeek,timeGridDay' 
            },
            
            buttonText: { today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', day: '‡∏ß‡∏±‡∏ô', list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' },
            
            selectable: true,
            navLinks: true, // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ
            slotMinTime: '08:00:00',
            slotMaxTime: '19:00:00',
            allDaySlot: false, // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á All Day ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà
            height: 'auto',
            
            events: "{% url 'bookings_api' %}?room_id={{ room.id }}",

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ Event ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            eventDidMount: function(info) {
                if (info.event.extendedProps.status === 'PENDING') {
                    info.el.classList.add('event-pending');
                } else if (info.event.extendedProps.status === 'APPROVED') {
                    info.el.classList.add('event-approved');
                }
            },

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏à‡∏≠‡∏á)
            select: function(info) {
                let startStr = formatDateTimeLocal(info.start);
                let endStr = formatDateTimeLocal(info.end);
                
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô Month View (All Day) ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Default 08:00-09:00
                if(info.allDay) {
                    let d = new Date(info.start);
                    d.setHours(8,0,0);
                    startStr = formatDateTimeLocal(d);
                    d.setHours(9,0,0);
                    endStr = formatDateTimeLocal(d);
                }

                prepareBookingModal(startStr, endStr);
            },
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Event (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î - ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏≥ Modal ‡πÅ‡∏¢‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Detail)
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                window.location.href = `/booking/detail/${info.event.id}/`;
            }
        });

        calendar.render();

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á DOM)
        bookingModalEl.addEventListener('hidden.bs.modal', function () {
            const $participantsSelect = $('#id_participants');
            if ($participantsSelect.data('select2')) { $participantsSelect.select2('destroy'); }
            document.getElementById('bookingFormContainer').appendChild(hiddenForm);
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        document.getElementById('submitBookingBtn').addEventListener('click', function() {
            const participantCountEl = document.getElementById('id_participant_count');
            let count = participantCountEl ? (parseInt(participantCountEl.value) || 1) : 1;

            if (count > ROOM_CAPACITY) {
                alert(`‚ùå ‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${count} ‡∏Ñ‡∏ô ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏´‡πâ‡∏≠‡∏á (${ROOM_CAPACITY} ‡∏Ñ‡∏ô)`);
                return;
            }
            
            // Disable ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            hiddenForm.submit();
        });
    });
    </script>
{% endblock %}