{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}ปฏิทินห้อง: {{ room.name }}{% endblock %}

{% block extra_head %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    {{ form.media.css }}
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        .fc { font-family: 'Kanit', sans-serif; }
        .fc-event { border: none !important; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; padding: 2px 5px; border-radius: 3px; }
        .fc-event.status-past { background-color: #6c757d !important; border-left: 3px solid #495057 !important; opacity: 1 !important; }
        
        /* เพิ่มสีต่างๆ */
        .bg-orange { background-color: #fd7e14 !important; color: white !important; }
        .bg-danger { background-color: #dc3545 !important; color: white !important; }
        .bg-primary { background-color: #0d6efd !important; color: white !important; }
        .bg-info { background-color: #0dcaf0 !important; color: white !important; } /* สีทำความสะอาด */

        .custom-event-content { padding: 2px; overflow: hidden; line-height: 1.2; }
        .fc-list .custom-event-content, .fc-list .custom-event-content .text-white, .fc-list .custom-event-content .text-dark { color: #212529 !important; text-shadow: none !important; }
        .fc-list-event:hover td { background-color: transparent !important; }
        .fc-list-event:hover { transform: none !important; box-shadow: none !important; }
        .select2-container { width: 100% !important; text-align: left !important; z-index: 99999 !important; }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered { display: flex !important; flex-direction: row !important; justify-content: flex-start !important; flex-wrap: wrap !important; text-align: left !important; padding-left: 0 !important; }
        .layout-card-label { cursor: pointer; width: 100%; height: 100%; display: block; position: relative; }
        .layout-card-label input[type="radio"] { position: absolute; top: 15px; left: 15px; z-index: 10; cursor: pointer; transform: scale(1.2); }
        .layout-card { border: 1px solid #dee2e6; background: #fff; border-radius: 8px; transition: border-color 0.2s; height: 100%; }
        .layout-card:hover { border-color: #adb5bd; background-color: #f8f9fa; }
        .layout-card-label input[type="radio"]:checked + .layout-card { border-color: #0d6efd !important; background-color: #fff !important; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1); }
        .check-icon { display: none !important; }
        .cursor-pointer { cursor: pointer; transition: opacity 0.2s; }
        .cursor-pointer:hover { opacity: 0.9; }
    </style>
{% endblock %}

{% block content %}
<div class="container py-4"> 
    <div class="card border-0 shadow-sm rounded-3 mb-4 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-3 position-relative" style="min-height: 200px;">
                {% if room.image %}
                    <img src="{{ room.image.url }}" class="w-100 h-100 object-fit-cover position-absolute cursor-pointer" onclick="showImage(this.src)" title="คลิกเพื่อขยายรูป">
                {% else %}
                    <div class="bg-light w-100 h-100 d-flex align-items-center justify-content-center text-muted position-absolute"><i class="bi bi-image fs-1 opacity-25"></i></div>
                {% endif %}
            </div>
            <div class="col-md-9">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="fw-bold text-primary mb-1">{{ room.name }}</h3>
                            <p class="text-muted mb-2"><i class="bi bi-geo-alt"></i> {{ room.building|default:"-" }} &bull; ชั้น {{ room.floor }}</p>
                            <div class="text-muted small mb-3">
                                <span class="me-3"><i class="bi bi-people-fill"></i>  จุ {{ room.capacity }} คน</span>
                                <span><i class="bi bi-tools"></i> {{ room.equipment_in_room|default:"-" }}</span>
                            </div>
                        </div>
                        <button class="btn btn-primary px-4 rounded-pill shadow-sm" onclick="openBookingModal()"><i class="bi bi-plus-lg me-1"></i> จองห้อง</button>
                    </div>
                    
                    <div class="mt-3 pt-3 border-top">
                        <small class="text-muted fw-bold d-block mb-2">สถานะการจอง:</small>
                        <div class="d-flex gap-2 align-items-center small flex-wrap">
                            <span class="badge bg-primary fw-normal px-2 py-1"><i class="bi bi-broadcast me-1"></i>กำลังใช้งาน</span>
                            <span class="badge bg-success fw-normal px-2 py-1"><i class="bi bi-check-circle-fill me-1"></i>อนุมัติแล้ว</span>
                            <span class="badge bg-warning text-dark fw-normal px-2 py-1"><i class="bi bi-hourglass-split me-1"></i>รออนุมัติ</span> 
                            <span class="badge bg-secondary fw-normal px-2 py-1"><i class="bi bi-clock-history me-1"></i>ใช้งานแล้ว</span>
                            <span class="badge bg-orange fw-normal px-2 py-1"><i class="bi bi-x-circle-fill me-1"></i>ไม่อนุมัติ</span>
                            <span class="badge bg-danger fw-normal px-2 py-1"><i class="bi bi-slash-circle-fill me-1"></i>ยกเลิก</span>
                            <span class="badge bg-info text-dark fw-normal px-2 py-1"><i class="bi bi-stars me-1"></i>ทำความสะอาด</span>
                            
                            <span class="ms-auto fw-bold text-danger d-none d-md-block"><i class="bi bi-info-circle-fill"></i> จองล่วงหน้าอย่างน้อย 30 นาที</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-4">
            <div class="alert alert-light d-flex align-items-center small mb-3 text-muted">
                <i class="bi bi-info-circle me-2"></i> คลิกลากบนปฏิทินเพื่อจอง หรือ ลากรายการเดิมเพื่อย้ายเวลา
            </div>
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> 
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-plus me-2"></i>จองห้องประชุม</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="modalBookingBody"></div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="submitBookingBtn">ยืนยัน</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-3">
            <div class="modal-header bg-light border-bottom-0">
                <h5 class="modal-title fw-bold">รายละเอียด</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <h5 id="detailModalTitle" class="fw-bold text-dark mb-3"></h5>
                
                <div class="d-flex align-items-center text-primary fw-bold mb-3 bg-primary bg-opacity-10 p-2 rounded">
                    <i class="bi bi-clock-history me-2"></i><span id="detailModalTime"></span>
                </div>
                <div class="mb-3">
                    <label class="small text-muted fw-bold text-uppercase">ห้องประชุม</label>
                    <div id="detailModalRoom" class="fs-5 text-dark fw-bold"></div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="small text-muted fw-bold text-uppercase">ผู้จอง</label>
                        <div id="detailModalUser" class="text-dark"></div>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold text-uppercase">สถานะ</label>
                        <div id="detailModalStatus"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light p-2">
                <a href="#" id="modalDetailLink" class="btn btn-sm btn-outline-primary w-100 rounded-pill">
                    <i class="bi bi-box-arrow-up-right me-2"></i>ดูรายละเอียดเพิ่มเติม
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center position-relative">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                <img id="expandedImage" src="" class="img-fluid rounded shadow-lg" style="max-height: 85vh;">
            </div>
        </div>
    </div>
</div>

<div id="bookingFormContainer" class="d-none">
    <form id="hiddenBookingForm" action="{% url 'room_calendar' room.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <input type="hidden" name="room" value="{{ room.id }}">
        
        {% if room.name == 'ห้องประชุมใหญ่' %}
            <div class="mb-4">
                <label class="form-label fw-bold"><i class="bi bi-grid-fill text-primary"></i> รูปแบบการจัดห้อง</label>
                <div class="row g-2">
                    {% for radio in form.room_layout %}
                    {% if radio.data.value %} 
                        <div class="col-6 col-md-4">
                            <label class="layout-card-label w-100 h-100">
                                {{ radio.tag }} 
                                <div class="card h-100 layout-card text-center p-3">
                                    <div class="mb-2 d-flex align-items-center justify-content-center" style="height: 60px;">
                                        {% if radio.data.value == 'other' %} <i class="bi bi-pencil-square fs-2 text-muted"></i>
                                        {% elif radio.data.value == 'boardroom' %} <img src="{% static 'images/layouts/conference.png' %}" class="img-fluid" style="max-height: 50px;">
                                        {% elif radio.data.value == 'banquet_rounds' %} <img src="{% static 'images/layouts/banquet_rounds.png' %}" class="img-fluid" style="max-height: 50px;">
                                        {% else %} <img src="{% static 'images/layouts/'|add:radio.data.value|add:'.png' %}" class="img-fluid" style="max-height: 50px;"> {% endif %}
                                    </div>
                                    <small class="fw-bold d-block">{{ radio.choice_label }}</small>
                                </div>
                            </label>
                        </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div id="layoutAttachmentDiv" class="mb-3 d-none">
                <label class="form-label small text-muted fw-bold">แนบไฟล์แผนผัง</label>
                {{ form.room_layout_attachment }}
            </div>
        {% else %} <input type="hidden" name="room_layout" value="theatre"> {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-2"> {{ form.title|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.participant_count|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.start_time|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.end_time|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.chairman|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.department|as_crispy_field }} </div>
            <div class="col-12 mb-2"> {{ form.equipments|as_crispy_field }} </div>
            
            <div class="col-12"><hr class="my-2 text-muted"></div>
            
            <div class="col-md-6 mb-2"> {{ form.presentation_file|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.presentation_link|as_crispy_field }} </div>
            
            <div class="col-12"><hr class="my-2 text-muted"></div>

            <div class="col-12 mb-2"> {{ form.description|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.additional_requests|as_crispy_field }} </div>
            <div class="col-md-6 mb-2"> {{ form.additional_notes|as_crispy_field }} </div>
            
            <div class="col-12 mb-2"> {{ form.recurrence|as_crispy_field }} </div>
            <div class="col-12 mb-2 d-none" id="recurrenceDateContainer"> {{ form.recurrence_end_date|as_crispy_field }} </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_scripts %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    {{ form.media.js }}
    
    <script>
    const ROOM_CAPACITY = parseInt("{{ room.capacity|default:0 }}");
    const CSRF_TOKEN = '{{ csrf_token }}'; 
    const API_UPDATE_URL = "{% url 'update_booking_time_api' %}";
    
    // ดึง Error จาก Server (ถ้ามี)
    {% if form.errors %}
        const SERVER_ERRORS = {{ form.errors.as_json|safe }};
    {% else %}
        const SERVER_ERRORS = null;
    {% endif %}

    function showImage(src) { document.getElementById('expandedImage').src = src; new bootstrap.Modal(document.getElementById('imageModal')).show(); }
    function getLocalISOString(date) { const offset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() - offset).toISOString().slice(0, 16); }
    
    function toggleAttachmentField() {
        const layoutRadios = document.querySelectorAll('input[name="room_layout"]');
        const attachmentDiv = document.getElementById('layoutAttachmentDiv');
        if (!attachmentDiv) return;
        let selectedValue = "";
        layoutRadios.forEach(radio => { if (radio.checked) selectedValue = radio.value; });
        if (selectedValue === 'other') { attachmentDiv.classList.remove('d-none'); } 
        else { attachmentDiv.classList.add('d-none'); }
    }

    function toggleRecurrenceDate() {
        const recurrenceSelect = document.getElementById('id_recurrence');
        const dateContainer = document.getElementById('recurrenceDateContainer');
        const dateInput = document.getElementById('id_recurrence_end_date');
        if (recurrenceSelect && dateContainer) {
            if (recurrenceSelect.value !== 'NONE') { dateContainer.classList.remove('d-none'); if(dateInput) dateInput.required = true; } 
            else { dateContainer.classList.add('d-none'); if(dateInput) { dateInput.value = ''; dateInput.required = false; } }
        }
    }

    function openBookingModal(startStr = null, endStr = null) {
        const form = document.getElementById('hiddenBookingForm');
        const modalBody = document.getElementById('modalBookingBody');
        if(!modalBody.contains(form)) { modalBody.appendChild(form); form.classList.remove('d-none'); }
        
        // ถ้าไม่มี Error ค่อยรีเซ็ต (ถ้ามี Error ให้คงค่าเดิมไว้ดู)
        if (!SERVER_ERRORS) {
            const modalEl = document.getElementById('bookingModal');
            if (!modalEl.classList.contains('show')) {
                form.reset();
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                $('#id_equipments').val(null).trigger('change');
            }
        }

        toggleAttachmentField(); toggleRecurrenceDate();
        
        if(startStr && endStr) {
            document.getElementById('id_start_time').value = startStr.substring(0, 16);
            document.getElementById('id_end_time').value = endStr.substring(0, 16);
        } else if (!SERVER_ERRORS && !document.getElementById('id_start_time').value) {
            let now = new Date(); let next = new Date(now.getTime() + 60*60000); 
            document.getElementById('id_start_time').value = getLocalISOString(now);
            document.getElementById('id_end_time').value = getLocalISOString(next);
        }
        new bootstrap.Modal(document.getElementById('bookingModal')).show();
    }

    function updateBookingOnServer(eventInfo) {
        fetch(API_UPDATE_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
            body: JSON.stringify({ id: eventInfo.event.id, start: eventInfo.event.start.toISOString(), end: eventInfo.event.end ? eventInfo.event.end.toISOString() : null })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') { 
                Swal.fire({ icon: 'success', title: 'ย้ายเวลาสำเร็จ', text: 'รายการรออนุมัติใหม่', timer: 2000, showConfirmButton: false });
                eventInfo.event.setExtendedProp('status', 'PENDING');
                eventInfo.event.setProp('classNames', ['bg-warning', 'text-dark', 'border-0']);
            } else { eventInfo.revert(); Swal.fire({ icon: 'error', title: 'แก้ไขไม่ได้', text: data.message }); }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.modal').forEach(modalEl => {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        });
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        // ถ้ามี Error จาก Server ให้แสดง Alert และเปิด Modal
        if (SERVER_ERRORS) {
            console.log("Validation Errors:", SERVER_ERRORS);
            let errorMsg = "";
            for (const [field, errors] of Object.entries(SERVER_ERRORS)) {
                let fieldName = field;
                if(field === 'start_time') fieldName = 'เวลาเริ่ม';
                if(field === 'end_time') fieldName = 'เวลาสิ้นสุด';
                if(field === 'title') fieldName = 'หัวข้อ';
                if(field === 'presentation_link') fieldName = 'ลิงก์เอกสาร';
                if(field === 'room') fieldName = 'ห้องประชุม';
                
                errors.forEach(err => { errorMsg += `• ${fieldName}: ${err.message}\n`; });
            }
            Swal.fire({
                icon: 'error',
                title: 'บันทึกไม่สำเร็จ',
                text: 'กรุณาตรวจสอบ:\n' + errorMsg,
                confirmButtonText: 'แก้ไขข้อมูล'
            }).then(() => {
                openBookingModal(); 
            });
        }

        const layoutRadios = document.querySelectorAll('input[name="room_layout"]');
        layoutRadios.forEach(radio => { radio.addEventListener('change', toggleAttachmentField); });
        const recurrenceSelect = document.getElementById('id_recurrence');
        if (recurrenceSelect) recurrenceSelect.addEventListener('change', toggleRecurrenceDate);

        var modalEl = document.getElementById('bookingModal');
        modalEl.addEventListener('shown.bs.modal', function () {
            $('.django-select2').select2({ theme: 'bootstrap-5', dropdownParent: $('#bookingModal'), width: '100%' });
        });

        var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            locale: 'th', initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listMonth' },
            buttonText: { today: 'วันนี้', month: 'เดือน', week: 'สัปดาห์', list: 'รายการ' },
            events: "{% url 'bookings_api' %}?room_id={{ room.id }}&t=" + new Date().getTime(),
            editable: true, selectable: true,
            
            eventContent: function(arg) {
                let timeText = arg.event.start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                if(arg.event.end) timeText += ' - ' + arg.event.end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                let status = arg.event.extendedProps.status;
                let colorClass = status === 'PENDING' ? 'text-dark' : 'text-white'; 
                return { html: `<div class="custom-event-content lh-sm" style="font-size: 0.8rem;"><div class="fw-bold ${colorClass} mb-1">${timeText}</div><div class="fw-bold text-truncate ${colorClass}">${arg.event.title}</div></div>`};
            },
            
            eventClassNames: function(arg) {
                let s = arg.event.extendedProps.status;
                let now = new Date();
                let end = arg.event.end || arg.event.start;
                if (s === 'CANCELLED') return ['bg-danger', 'border-0']; 
                if (s === 'REJECTED') return ['bg-orange', 'border-0'];
                if (s === 'CLEANING') return ['bg-info', 'border-0']; // เพิ่มเงื่อนไขสีทำความสะอาด
                if (end < now) return ['bg-secondary', 'border-0']; 
                if (s === 'PENDING') return ['bg-warning', 'text-dark', 'border-0'];
                if (s === 'APPROVED') {
                    if (arg.event.start <= now && now <= end) return ['bg-primary', 'border-0'];
                    return ['bg-success', 'border-0'];
                }
                return ['bg-secondary'];
            },

            eventDrop: function(info) { Swal.fire({ title: 'ยืนยันย้ายเวลา?', icon: 'warning', showCancelButton: true }).then((r) => { if (r.isConfirmed) updateBookingOnServer(info); else info.revert(); }); },
            eventResize: function(info) { Swal.fire({ title: 'ยืนยันปรับเวลา?', icon: 'warning', showCancelButton: true }).then((r) => { if (r.isConfirmed) updateBookingOnServer(info); else info.revert(); }); },
            select: function(info) {
                let start = info.allDay ? info.startStr + 'T08:00' : info.startStr.substring(0, 16);
                let end = info.allDay ? info.startStr + 'T09:00' : info.endStr.substring(0, 16);
                document.getElementById('id_start_time').value = start; document.getElementById('id_end_time').value = end;
                openBookingModal(start, end);
            },
            eventClick: function(info) {
                if (info.jsEvent.detail > 1) return; info.jsEvent.preventDefault();
                document.getElementById('detailModalTitle').innerText = info.event.title;
                document.getElementById('detailModalRoom').innerText = info.event.extendedProps.room;
                document.getElementById('detailModalUser').innerText = info.event.extendedProps.user;
                
                let s = info.event.start; let e = info.event.end;
                let t = s.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'numeric'}) + ' | ' + s.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                if(e) t += ' - ' + e.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('detailModalTime').innerText = t;

                let sk = info.event.extendedProps.status; let st = sk; let bg = 'bg-secondary';
                if (sk === 'APPROVED') { st = 'อนุมัติแล้ว'; bg = 'bg-success'; }
                else if (sk === 'PENDING') { st = 'รออนุมัติ'; bg = 'bg-warning text-dark'; }
                else if (sk === 'REJECTED') { st = 'ไม่อนุมัติ'; bg = 'bg-orange'; } 
                else if (sk === 'CANCELLED') { st = 'ยกเลิกแล้ว'; bg = 'bg-danger'; }
                else if (sk === 'CLEANING') { st = 'ทำความสะอาด'; bg = 'bg-info'; } // เพิ่มเงื่อนไขการแสดงผลใน Modal
                
                document.getElementById('detailModalStatus').innerHTML = `<span class="badge ${bg}">${st}</span>`;
                
                const detailLink = document.getElementById('modalDetailLink');
                detailLink.href = `/booking/${info.event.id}/detail/`;
                detailLink.onclick = function() {
                    const modalEl = document.getElementById('eventDetailModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                };

                new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
            },
            eventDidMount: function(info) {
                var now = new Date(); var end = info.event.end || info.event.start;
                var status = info.event.extendedProps.status;
                if (end < now || status === 'CANCELLED' || status === 'REJECTED') { info.event.setProp('editable', false); }
                if (end < now && status !== 'CANCELLED' && status !== 'REJECTED') { info.el.classList.add('status-past'); }
            }
        });
        calendar.render();

        document.getElementById('submitBookingBtn').addEventListener('click', function() {
            const form = document.getElementById('hiddenBookingForm');
            if (!form.checkValidity()) {
                form.reportValidity(); 
                return; 
            }
            const start = new Date(document.getElementById('id_start_time').value);
            const now = new Date();
            if (start < now) { Swal.fire({ icon: 'error', title: 'จองย้อนหลังไม่ได้' }); return; }
            
            const count = parseInt(document.getElementById('id_participant_count').value || 0);
            if (ROOM_CAPACITY > 0 && count > ROOM_CAPACITY) { Swal.fire({ icon: 'warning', title: 'เกินความจุห้อง!' }); return; }
            
            this.disabled = true; this.innerHTML = 'กำลังบันทึก...';
            form.submit();
        });
    });
    </script>
{% endblock %}