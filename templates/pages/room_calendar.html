{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_head %}
    {{ form.media.css }}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        :root {
            --fc-border-color: #a8a8a8;
            --fc-today-bg-color: #fffcfc;
        }
        .fc { font-family: 'Kanit', sans-serif; }
        .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 500; }
        #calendar { margin-top: 1.5rem; }
        .modal-header { padding-bottom: 5px !important; }
        .modal-body { padding-top: 10px !important; }
        
        /* Select2 Styling */
        .select2-selection__rendered { display: flex !important; flex-wrap: wrap !important; align-items: center !important; }
        .select2-selection__choice { margin-top: 0 !important; margin-bottom: 2px !important; }
        .select2-search--inline { float: none !important; flex-grow: 1 !important; }
        
        /* Calendar Event Styling */
        .fc-event.event-pending { background-color: #f39c12 !important; border-color: #f39c12 !important; }
        .fc-daygrid-day-frame { position: relative; min-height: 100px; }
        .fc-day-available-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.25rem; color: #c7c5c5; font-weight: 600;
            z-index: 1; pointer-events: none;
        }
        .fc-daygrid-event { z-index: 2 !important; }

        /* --- üì± Responsive Fixes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ --- */
        @media (max-width: 768px) {
            .fc .fc-toolbar {
                flex-direction: column; /* ‡∏à‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
                gap: 10px;
            }
            .fc .fc-toolbar-title {
                font-size: 1.1rem;
            }
            .content-card {
                padding: 1rem !important; /* ‡∏•‡∏î padding ‡∏Å‡∏≤‡∏£‡πå‡∏î */
            }
            /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
            .fc-daygrid-day-frame { min-height: 60px; } 
            .fc-day-available-text { font-size: 0.9rem; }
        }
    </style>
{% endblock %}


{% block content %}
    <div class="py-4"> 
        <div class="content-card shadow-sm border p-3 p-md-4 mb-4 bg-white rounded-3">
            <div class="row g-4">
                <div class="col-lg-5">
                    {% if room.image %}
                        <img src="{{ room.image.url }}" class="d-block w-100 shadow-sm" style="height: 250px; object-fit: cover; border-radius: 0.5rem;" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á {{ room.name }}">
                    {% else %}
                        <div class="bg-light text-muted d-flex align-items-center justify-content-center shadow-sm" style="height: 250px; border-radius: 0.5rem;">
                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col-lg-7">
                    <h4 class="fw-bold text-primary mb-2">{{ room.name }}</h4> 
                    <p class="text-muted small mb-3">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        {{ room.location|default:"(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)" }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-people-fill me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {{ room.capacity }} ‡∏Ñ‡∏ô
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-building me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> {{ room.building|default:"-" }} (‡∏ä‡∏±‡πâ‡∏ô {{ room.floor|default:"-" }})
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-tools me-2 text-muted" style="width: 1.25em;"></i>
                            <strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong>
                        </li>
                    </ul>
                    <div class="small text-muted ps-4" style="margin-left: 1.25em;">
                        {{ room.equipment_in_room|default:"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"|linebreaksbr }}
                    </div>
                    
                    <div class="d-block d-md-none mt-3">
                        <button class="btn btn-primary w-100 rounded-pill" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="prepareBookingModal()">
                            <i class="bi bi-plus-circle me-1"></i> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card shadow-sm border p-3 p-md-4 bg-white rounded-3">
            <h5 class="mb-0"><i class="bi bi-calendar3 me-2 text-primary"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
            <p class="text-muted small mb-0">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á</p>
            <div id="calendar"></div>
        </div>
    </div>

    <div id="bookingFormContainer" style="display:none;">
        <form id="hiddenBookingForm" action="{% url 'create_booking' room.id %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
        </form>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBookingBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" id="submitBookingBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block extra_scripts %} 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/th.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    {{ form.media.js }}

    <script>
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
    function prepareBookingModal() {
        const hiddenForm = document.getElementById('hiddenBookingForm');
        const modalBody = document.getElementById('modalBookingBody');
        const $participantsSelect = $('#id_participants');

        // ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Modal
        if (!modalBody.contains(hiddenForm)) {
            modalBody.appendChild(hiddenForm);
        }
        
        // Re-init Select2 inside Modal
        if ($participantsSelect.data('select2')) { $participantsSelect.select2('destroy'); }
        $participantsSelect.select2({
            theme: 'bootstrap-5', language: 'th', width: '100%',
            dropdownParent: $('#bookingModal .modal-content')
        });
        
        // Set default date/time to now if not set
        const now = new Date();
        // (Optional: Logic to set default time if needed)
    }

    $(document).ready(function() {
        
        const calendarEl = document.getElementById('calendar');
        const hiddenForm = document.getElementById('hiddenBookingForm');
        const modalBody = document.getElementById('modalBookingBody');
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const bookingModalEl = document.getElementById('bookingModal');
        const ROOM_CAPACITY = {{ room.capacity|default:1 }}; 

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const isMobile = window.innerWidth < 768;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡πÅ‡∏Æ‡πá‡∏Ñ" '‡∏ß‡πà‡∏≤‡∏á' 
        function addAvailableText(view) {
            setTimeout(function() { 
                document.querySelectorAll('.fc-day-available-text').forEach(el => el.remove());
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ß‡πà‡∏≤‡∏á" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                if (view.type === 'dayGridMonth') {
                    let dayCells = document.querySelectorAll('.fc-daygrid-day');
                    dayCells.forEach(function(dayCell) {
                        let eventElements = dayCell.querySelectorAll('.fc-event'); 
                        let isPast = dayCell.classList.contains('fc-day-past');
                        let isOtherMonth = dayCell.classList.contains('fc-day-other');
                        if (eventElements.length === 0 && !isPast && !isOtherMonth) {
                            let availableEl = document.createElement('div');
                            availableEl.className = 'fc-day-available-text';
                            availableEl.innerHTML = '‡∏ß‡πà‡∏≤‡∏á';
                            let dayFrame = dayCell.querySelector('.fc-daygrid-day-frame');
                            if (dayFrame) {
                                dayFrame.appendChild(availableEl);
                            }
                        }
                    });
                }
            }, 100); 
        }
        
        function formatDateTimeLocal(date, defaultHour = null, defaultMinute = null) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = (defaultHour !== null ? defaultHour : date.getHours()).toString().padStart(2, '0');
            const minutes = (defaultMinute !== null ? defaultMinute : date.getMinutes()).toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
            // 2. ‡∏õ‡∏£‡∏±‡∏ö View ‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (TimeGrid), ‡∏Ñ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            initialView: isMobile ? 'timeGridDay' : 'dayGridMonth', 
            locale: 'th',
            
            // 3. ‡∏õ‡∏£‡∏±‡∏ö Toolbar ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            headerToolbar: {
                left: isMobile ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: isMobile ? 'timeGridDay,listWeek' : 'dayGridMonth,timeGridWeek,timeGridDay' 
            },
            
            buttonText: { today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', day: '‡∏ß‡∏±‡∏ô', list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' },
            selectable: true,
            editable: false,
            height: 'auto', // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            allDaySlot: false, // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á All Day ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            slotMinTime: '08:00:00', // ‡πÄ‡∏£‡∏¥‡πà‡∏° 8 ‡πÇ‡∏°‡∏á
            slotMaxTime: '20:00:00', // ‡∏à‡∏ö 2 ‡∏ó‡∏∏‡πà‡∏°
            
            events: "{% url 'bookings_api' %}?room_id={{ room.id }}",

            eventDidMount: function(info) {
                 if (info.event.extendedProps.status === 'PENDING') {
                    info.el.classList.add('event-pending');
                }
            },

            datesSet: function(info) {
                addAvailableText(info.view);
            },
            loading: function(isLoading) {
                if (!isLoading) { 
                    addAvailableText(this.view); 
                }
            },

            select: function(info) {
                let startStr, endStr;
                
                if (info.allDay) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å Month View) ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ default 08:00 - 09:00
                    startStr = formatDateTimeLocal(info.start, 8, 0); 
                    endStr = formatDateTimeLocal(info.start, 9, 0); 
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏à‡∏≤‡∏Å TimeGrid View) ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    startStr = formatDateTimeLocal(info.start);
                    endStr = formatDateTimeLocal(info.end);
                }
                
                hiddenForm.reset(); 

                document.getElementById('id_start_time').value = startStr;
                document.getElementById('id_end_time').value = endStr;
                
                modalBody.appendChild(hiddenForm);
                
                var $participantsSelect = $('#id_participants');
                if ($participantsSelect.data('select2')) { $participantsSelect.select2('destroy'); }
                $participantsSelect.select2({
                    theme: 'bootstrap-5', language: 'th', width: '100%',
                    dropdownParent: $('#bookingModal .modal-content')
                });
                
                bookingModal.show();
            },
            
            eventClick: function(info) {
                info.jsEvent.preventDefault(); 
                let bookingId = info.event.id;
                let detailUrl = `/booking/detail/${bookingId}/`; 
                window.location.href = detailUrl;
            }
        });

        calendar.render(); 

        bookingModalEl.addEventListener('hidden.bs.modal', function () {
            var $participantsSelect = $('#id_participants');
            if ($participantsSelect.data('select2')) {
                $participantsSelect.select2('destroy');
            }
            document.getElementById('bookingFormContainer').appendChild(hiddenForm);
        });
        
        document.getElementById('submitBookingBtn').addEventListener('click', function(event) {
            const participantCountEl = document.getElementById('id_participant_count');
            let participantCountVal = 1; 
            if (participantCountEl) {
                participantCountVal = parseInt(participantCountEl.value) || 1;
            }

            if (participantCountVal > ROOM_CAPACITY) {
                alert(`‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (${participantCountVal} ‡∏Ñ‡∏ô) ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á (${ROOM_CAPACITY} ‡∏Ñ‡∏ô)! \n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•`);
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            hiddenForm.submit();
        });
    });
    </script>

{% endblock %}