{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
  .fc-event.vacant { background-color: #28a745; border-color: #28a745;}
  .fc-event.booked { background-color: #007bff; border-color: #007bff;}
  .fc-event.pending { background-color: #ffc107; border-color: #ffc107; color: #212529 !important;}
  .room-card { border: 1px solid #dee2e6; padding:1rem; margin-bottom:1.5rem; border-radius:0.75rem; display:flex; gap:1rem; background-color: #fff; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
  .room-card img { width:150px; height:100px; object-fit:cover; border-radius:0.5rem; }
  
  /* --- 3. ❌ ลบ {{ form.media.css }} ออก ❌ --- */
  .select2-container--open { z-index: 1060; } 
  /* --- ------------------------------------ --- */
</style>
{% endblock %}


{% block content %}

{# (ส่วน HTML แสดง room-card, calendar ... เหมือนเดิม) #}
<div class="room-card align-items-center">
  {% if room.image %} <img src="{{ room.image.url }}" alt="รูปภาพ {{ room.name }}"> {% else %} <div class="bg-light d-flex align-items-center justify-content-center rounded" style="width:150px; height:100px;"> <i class="bi bi-image text-muted fs-1"></i> </div> {% endif %}
  <div> <h4 class="mb-1">{{ room.name }}</h4> <p class="mb-1 text-muted"><i class="bi bi-people-fill me-1"></i>รองรับ: {{ room.capacity }} คน</p> <p class="mb-0 text-muted small"><i class="bi bi-tools me-1"></i>อุปกรณ์: {{ room.equipment_in_room|default:"-"|linebreaksbr }}</p> </div>
</div>
<div id='calendar' class="bg-white p-3 rounded shadow-sm"></div>

{# (Modal "สร้าง" การจอง - โค้ด HTML เหมือนเดิมทุกประการ) #}
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-3">
      <form action="{% url 'create_booking_for_room' room.id %}" method="POST" enctype="multipart/form-data" id="bookingForm">
        {% csrf_token %}
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title" id="bookingModalLabel"><i class="bi bi-calendar-plus-fill me-2 text-primary"></i>กรอกข้อมูลการจอง</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-4 px-4">
            {% if form.non_field_errors %} <div class="alert alert-danger small p-2" role="alert"> {% for error in form.non_field_errors %} {{ error }} {% endfor %} </div> {% endif %}
            <p class="mb-3 small text-muted">ห้อง: <strong>{{ room.name }}</strong></p>
            <div style="display:none;">{{ form.room }}{{ form.status }}</div>
            <div class="row g-3">
                <div class="col-12"> <label for="{{ form.title.id_for_label }}" class="form-label small fw-bold">{{ form.title.label }}</label> {{ form.title }} {% if form.title.errors %}<div class="invalid-feedback d-block small">{{ form.title.errors|first }}</div>{% endif %} </div>
                <div class="col-md-6"> <label for="{{ form.chairman.id_for_label }}" class="form-label small fw-bold">{{ form.chairman.label }}</label> {{ form.chairman }} {% if form.chairman.errors %}<div class="invalid-feedback d-block small">{{ form.chairman.errors|first }}</div>{% endif %} </div>
                 <div class="col-md-6"> <label for="{{ form.department.id_for_label }}" class="form-label small fw-bold">{{ form.department.label }}</label> {{ form.department }} {% if form.department.errors %}<div class="invalid-feedback d-block small">{{ form.department.errors|first }}</div>{% endif %} </div>
                <div class="col-md-6"> <label for="{{ form.start_time.id_for_label }}" class="form-label small fw-bold">{{ form.start_time.label }}</label> {{ form.start_time }} {% if form.start_time.errors %}<div class="invalid-feedback d-block small">{{ form.start_time.errors|first }}</div>{% endif %} </div>
                <div class="col-md-6"> <label for="{{ form.end_time.id_for_label }}" class="form-label small fw-bold">{{ form.end_time.label }}</label> {{ form.end_time }} {% if form.end_time.errors %}<div class="invalid-feedback d-block small">{{ form.end_time.errors|first }}</div>{% endif %} </div>
                <div class="col-md-6"> <label for="{{ form.participant_count.id_for_label }}" class="form-label small fw-bold">{{ form.participant_count.label }}</label> {{ form.participant_count }} {% if form.participant_count.errors %}<div class="invalid-feedback d-block small">{{ form.participant_count.errors|first }}</div>{% endif %} {% if form.participant_count.help_text %}<div class="form-text small">{{ form.participant_count.help_text|safe }}</div>{% endif %} </div>
                 <div class="col-md-6"></div>
                 
                 {# ช่องค้นหาผู้ใช้ในระบบ #}
                 <div class="col-12"> <label for="{{ form.participants.id_for_label }}" class="form-label small fw-bold">{{ form.participants.label }}</label> 
                    {{ form.participants }} {# <-- นี่คือ Field ที่มี class .select2-ajax-users #}
                    {% if form.participants.errors %}<div class="invalid-feedback d-block small">{{ form.participants.errors|first }}</div>{% endif %} 
                    {% if form.participants.help_text %}<div class="form-text small">{{ form.participants.help_text|safe }}</div>{% endif %} 
                 </div>
                 
                 {# ช่องพิมพ์ชื่อแขกภายนอก #}
                 <div class="col-12"> 
                    <label for="{{ form.external_participants.id_for_label }}" class="form-label small fw-bold">{{ form.external_participants.label }}</label>
                    {{ form.external_participants }}
                    {% if form.external_participants.errors %}<div class="invalid-feedback d-block small">{{ form.external_participants.errors|first }}</div>{% endif %}
                    {% if form.external_participants.help_text %}<div class="form-text small">{{ form.external_participants.help_text|safe }}</div>{% endif %}
                 </div>

                <div class="col-12"> <label for="{{ form.description.id_for_label }}" class="form-label small fw-bold">{{ form.description.label }}</label> {{ form.description }} {% if form.description.errors %}<div class="invalid-feedback d-block small">{{ form.description.errors|first }}</div>{% endif %} </div>
                 <div class="col-md-6"> <label for="{{ form.presentation_file.id_for_label }}" class="form-label small fw-bold">{{ form.presentation_file.label }}</label> {{ form.presentation_file }} {% if form.presentation_file.errors %}<div class="invalid-feedback d-block small">{{ form.presentation_file.errors|first }}</div>{% endif %} {% if form.presentation_file.help_text %}<div class="form-text small">{{ form.presentation_file.help_text|safe }}</div>{% endif %} </div>
                 <div class="col-md-6"> <label for="{{ form.attachment.id_for_label }}" class="form-label small fw-bold">{{ form.attachment.label }}</label> {{ form.attachment }} {% if form.attachment.errors %}<div class="invalid-feedback d-block small">{{ form.attachment.errors|first }}</div>{% endif %} {% if form.attachment.help_text %}<div class="form-text small">{{ form.attachment.help_text|safe }}</div>{% endif %} </div>
                <div class="col-12"> <label for="{{ form.additional_requests.id_for_label }}" class="form-label small fw-bold">{{ form.additional_requests.label }}</label> {{ form.additional_requests }} {% if form.additional_requests.errors %}<div class="invalid-feedback d-block small">{{ form.additional_requests.errors|first }}</div>{% endif %} </div>
                <div class="col-12"> <label for="{{ form.additional_notes.id_for_label }}" class="form-label small fw-bold">{{ form.additional_notes.label }}</label> {{ form.additional_notes }} {% if form.additional_notes.errors %}<div class="invalid-feedback d-block small">{{ form.additional_notes.errors|first }}</div>{% endif %} </div>
            </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="submit" class="btn btn-primary rounded-pill px-4">ยืนยันการจอง</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# (Modal "Event Action" ... เหมือนเดิม) #}
<div class="modal fade" id="eventActionModal" ...> ... </div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

{# --- 4. ❌ ลบ {{ form.media.js }} ออก ❌ --- #}

{# บล็อกสำหรับส่งค่า Django ให้ JavaScript #}
<script>
    const currentUserId = {{ request.user.id }};
    const csrfToken = "{{ csrf_token }}";
    const isAdminUser = {{ is_admin_user|yesno:"true,false" }};
    const roomId = {{ room.id }};
    const bookingsApiUrl = "{% url 'api_bookings' %}?room_id=" + roomId;
    const deleteApiUrlTemplate = "{% url 'delete_booking_api' 0 %}".replace('/0/', '/__EVENT_ID__/');
    const detailUrlTemplate = "{% url 'booking_detail' 0 %}".replace('/0/', '/__EVENT_ID__/');
    const editUrlTemplate = "{% url 'edit_booking' 0 %}".replace('/0/', '/__EVENT_ID__/');
</script>

{# บล็อก JavaScript หลัก #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  let calendarEl = document.getElementById('calendar');
  let createModalEl = document.getElementById("bookingModal");
  let createBookingModal = new bootstrap.Modal(createModalEl);
  let actionModalEl = document.getElementById("eventActionModal");
  let eventActionModal = new bootstrap.Modal(actionModalEl);
  const isAdmin = isAdminUser;

  // --- 5. ✅ เพิ่ม: Script สั่งงาน Select2 AJAX ✅ ---
  // (ใช้ jQuery ที่โหลดจาก base.html)
  $('.select2-ajax-users').select2({
      theme: 'bootstrap-5', // ใช้ธีม Bootstrap 5
      width: '100%',
      dropdownParent: $('#bookingModal'), // *** สำคัญมาก: บอกให้ Dropdown แสดงใน Modal ***
      ajax: {
          url: "{% url 'user-autocomplete' %}", // URL ที่เราสร้างไว้ใน booking/urls.py
          dataType: 'json',
          delay: 250, // หน่วงเวลา 0.25 วินาที ก่อนค้นหา
          data: function (params) {
              return {
                  q: params.term // ส่งคำค้นหา (q)
              };
          },
          processResults: function (data) {
              // แปลงผลลัพธ์ JSON ให้อยู่ในรูปแบบที่ Select2 ต้องการ (id และ text)
              return {
                  results: $.map(data.results, function(item) {
                      return {
                          id: item.id,
                          text: item.text // 'text' นี้มาจาก get_result_label ใน View
                      };
                  })
              };
          },
          cache: true
      },
      minimumInputLength: 2, // ต้องพิมพ์อย่างน้อย 2 ตัวอักษรถึงจะเริ่มค้นหา
  });
  // --- ---------------------------------------- ---


  // --- 6. ✅ แก้ไข: เพิ่ม .form-select (แต่ยกเว้น .select2-ajax-users) ✅ ---
  $('#bookingForm').find('input[type="text"], input[type="number"], input[type="datetime-local"], textarea').addClass('form-control form-control-sm');
  $('#bookingForm').find('select:not(.select2-ajax-users)').addClass('form-select form-select-sm'); // <-- เพิ่ม :not()
  $('#bookingForm').find('input[type="file"]').addClass('form-control form-control-sm');
  // --- --------------------------------------------- ---

  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    selectable: true,
    selectMirror: true,
    timeZone: 'Asia/Bangkok',
    slotDuration: '01:00:00',
    slotMinTime: '08:00:00',
    slotMaxTime: '19:00:00', // <-- (แก้ตามที่คุณขอล่าสุด)
    allDaySlot: false,
    events: bookingsApiUrl,
    eventClassNames: function(info) {
      if(info.event.extendedProps.status === 'APPROVED') return ['booked'];
      else if(info.event.extendedProps.status === 'PENDING') return ['pending'];
      else return ['vacant'];
    },
    select: function(info) {
      let now = new Date();
      let start = info.start;
      if(start < now){ alert("ไม่สามารถจองย้อนหลังได้"); calendar.unselect(); return; }
      for(let ev of calendar.getEvents()){
        if( (start < ev.end) && (info.end > ev.start) && (ev.extendedProps.status === 'APPROVED' || ev.extendedProps.status === 'PENDING') ){
          alert("ช่วงเวลานี้ถูกจองหรือรออนุมัติแล้ว"); calendar.unselect(); return;
        }
      }
      $('#bookingForm').trigger("reset");
      $('#bookingForm').find('.is-invalid').removeClass('is-invalid');
      
      // --- 7. ✅ แก้ไข: Reset Autocomplete Field ✅ ---
      $('#bookingForm [name="participants"]').val(null).trigger('change');
      // --- ---------------------------------------- ---

      $("#bookingModal [name='room']").val(roomId);
      $("#bookingModal [name='start_time']").val(info.startStr.slice(0, 16));
      $("#bookingModal [name='end_time']").val(info.endStr.slice(0, 16));
      createBookingModal.show();
      calendar.unselect();
    },
    eventClick: function(info){
        let eventId = info.event.id;
        let eventTitle = info.event.title;
        let isOwner = (info.event.extendedProps.user_id == currentUserId);
        let canModify = (isOwner || isAdmin);
        $('#eventActionModalTitle').text(eventTitle);
        $('#eventActionModalLabel').text("ตัวเลือกการจอง");
        $(actionModalEl).data('eventId', eventId);
        $('#btnViewDetails').show();
        $('#btnEditBooking').toggle(canModify);
        $('#btnCancelBooking').toggle(canModify);
        eventActionModal.show();
    },
    editable: false,
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' }
  });
  calendar.render();

  // --- (Event Listeners for Action Modal Buttons - เหมือนเดิม) ---
  $('#btnViewDetails').on('click', function() { let eventId = $(actionModalEl).data('eventId'); let url = detailUrlTemplate.replace('__EVENT_ID__', eventId); window.location.href = url; eventActionModal.hide(); });
  $('#btnEditBooking').on('click', function() { let eventId = $(actionModalEl).data('eventId'); let url = editUrlTemplate.replace('__EVENT_ID__', eventId); window.open(url, '_self'); eventActionModal.hide(); });
  $('#btnCancelBooking').on('click', function() { let eventId = $(actionModalEl).data('eventId'); if(confirm("คุณต้องการยืนยันการยกเลิกการจองนี้ใช่หรือไม่?")){ let finalUrl = deleteApiUrlTemplate.replace('__EVENT_ID__', eventId); fetch(finalUrl, { method: "POST", headers: { "X-CSRFToken": csrfToken, "Accept": "application/json" }, }).then(res => res.json()).then(data => { if(data.success){ alert("ยกเลิกเรียบร้อย"); calendar.getEventById(eventId)?.remove(); } else { alert("เกิดข้อผิดพลาด: " + data.error); } }).catch(err => { console.error(err); alert("เกิดข้อผิดพลาดร้ายแรง ไม่สามารถติดต่อเซิร์ฟเวอร์ได้"); }); } eventActionModal.hide(); });
});
</script>
{% endblock %}