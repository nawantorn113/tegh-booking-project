{% extends 'base.html' %}
{% load static %}
{% block title %}{{ room.name }} - Calendar{% endblock %}

{% block extra_head %}
    {{ form.media.css }}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <style>
        #calendar { max-width: 1100px; margin: 0 auto; }
        .fc .fc-button-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .select2-container { width: 100% !important; }
        .fc-event-draggable, .fc-event-resizable { cursor: move; }
    </style>
{% endblock %}

{% block content %}
<a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm mb-3"><i class="bi bi-arrow-left"></i> กลับสู่หน้าหลัก</a>
<h1 class="mb-1">ตารางการใช้ห้อง: {{ room.name }}</h1>
<p class="text-muted mb-4">{{ room.building }} - {{ room.floor }}</p>

<span id="admin-status-flag" data-is-admin="{{ is_admin_user|yesno:'true,false' }}" style="display: none;"></span>

<div id='calendar-container' class="bg-white p-3 rounded shadow-sm">
    <div id='calendar'></div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">สร้างการจองสำหรับห้อง {{ room.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bookingForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {{ form.room }}
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                        {{ form.title }}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.start_time.id_for_label }}" class="form-label">{{ form.start_time.label }}</label>
                            {{ form.start_time }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.end_time.id_for_label }}" class="form-label">{{ form.end_time.label }}</label>
                            {{ form.end_time }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.participants.id_for_label }}" class="form-label">{{ form.participants.label }}</label>
                        {{ form.participants }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.additional_requests.id_for_label }}" class="form-label">{{ form.additional_requests.label }}</label>
                        {{ form.additional_requests }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">ยืนยันการจอง</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingActionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingActionModalLabel">จัดการการจอง</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>คุณต้องการทำอะไรกับการจองนี้:</p>
                <h6 id="modalBookingTitle" class="fw-bold"></h6>
                <div class="d-grid gap-2 mt-3">
                    <a id="viewDetailBtn" href="#" class="btn btn-outline-primary"><i class="bi bi-info-circle-fill me-2"></i>ดูรายละเอียด</a>
                    <a id="editBtn" href="#" class="btn btn-outline-warning"><i class="bi bi-pencil-fill me-2"></i>แก้ไขการจอง</a>
                    <form id="deleteForm" method="post" class="d-grid">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash-fill me-2"></i>ยกเลิกการจอง</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ form.media.js }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var bookingModalEl = document.getElementById('bookingModal');
        var actionModalEl = document.getElementById('bookingActionModal');

        if (calendarEl && bookingModalEl && actionModalEl) {
            var bookingModal = new bootstrap.Modal(bookingModalEl);
            var actionModal = new bootstrap.Modal(actionModalEl);
            const bookingForm = document.getElementById('bookingForm');
            const adminFlag = document.getElementById('admin-status-flag');
            const isCurrentUserAdmin = adminFlag.dataset.isAdmin === 'true';

            function updateBookingTime(info) {
                const isOwner = info.event.title.includes("({{ request.user.username }})");
                if (!isOwner && !isCurrentUserAdmin) {
                    alert("คุณไม่มีสิทธิ์แก้ไขการจองนี้");
                    info.revert();
                    return;
                }
                if (!confirm("คุณต้องการเปลี่ยนเวลาการจองนี้ใช่หรือไม่?")) {
                    info.revert();
                    return;
                }
                fetch(`/api/booking/update-time/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({
                        booking_id: info.event.id,
                        start_time: info.event.start.toISOString(),
                        end_time: info.event.end.toISOString(),
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status !== 'success') {
                        alert('Error: ' + result.message);
                        info.revert();
                    } else {
                        calendar.refetchEvents();
                    }
                }).catch(error => {
                    alert('An unexpected error occurred.');
                    info.revert();
                });
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                initialView: 'timeGridWeek',
                slotMinTime: '08:00:00',
                slotMaxTime: '19:00:00',
                selectable: true,
                editable: true,
                events: `/api/bookings/?room_id={{ room.id }}`,
                select: function(info) {
                    const formatDateTimeLocal = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                    document.getElementById('{{ form.start_time.id_for_label }}').value = formatDateTimeLocal(info.start);
                    document.getElementById('{{ form.end_time.id_for_label }}').value = formatDateTimeLocal(info.end);
                    bookingForm.action = `{% url 'create_booking_for_room' room.id %}`;
                    bookingModal.show();
                    calendar.unselect();
                },
                eventClick: function(info) {
                    info.jsEvent.preventDefault();

                    const modalTitle = actionModalEl.querySelector('#modalBookingTitle');
                    const viewDetailBtn = actionModalEl.querySelector('#viewDetailBtn');
                    const editBtn = actionModalEl.querySelector('#editBtn');
                    const deleteForm = actionModalEl.querySelector('#deleteForm');

                    let cleanTitle = info.event.title.split('\\n')[0];
                    if (cleanTitle.startsWith('[')) {
                        cleanTitle = cleanTitle.substring(cleanTitle.indexOf(']') + 2);
                    }
                    modalTitle.textContent = cleanTitle;

                    viewDetailBtn.href = `/booking/${info.event.id}/`;
                    editBtn.href = `/booking/${info.event.id}/edit/`;
                    deleteForm.action = `/booking/${info.event.id}/delete/`;

                    const isOwner = info.event.title.includes("({{ request.user.username }})");
                    const canManage = isOwner || isCurrentUserAdmin;

                    if (canManage) {
                        editBtn.style.display = 'block';
                        deleteForm.style.display = 'block';
                    } else {
                        editBtn.style.display = 'none';
                        deleteForm.style.display = 'none';
                    }

                    actionModal.show();
                },
                eventDrop: updateBookingTime,
                eventResize: updateBookingTime
            });
            calendar.render();
        } else {
            console.error("Critical Error: Calendar or Modal element not found!");
        }
    });
</script>
{% endblock %}