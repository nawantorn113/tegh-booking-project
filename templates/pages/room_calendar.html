{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}{% endblock %}

{% block extra_head %}
<link href="{% static 'vendor/fullcalendar/main.min.css' %}" rel="stylesheet" />
<style>
    /* (‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô) */
    :root {
        --fc-border-color: #e9ecef;
        --fc-today-bg-color: #f8f9fa;
        --fc-button-active-bg-color: #4338ca;
        --fc-button-active-border-color: #4338ca;
    }
    .fc {
        font-family: 'Kanit', sans-serif;
    }
    .fc .fc-toolbar-title {
        font-size: 1.25rem;
        font-weight: 500;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ó‡∏≥‡πÉ‡∏´‡πâ Layout ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á) */
    .room-image {
        height: 200px; 
        object-fit: cover; 
        border-radius: 0.5rem;
    }
    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    #calendar {
        margin-top: 1.5rem;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ JS ‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà Modal */
    #bookingFormContainer {
        display: none;
    }
</style>
{% endblock %}


{% block content %}

    <div class="page-header">
        <h5 class="mb-0">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h5>
    </div>

    <div class="content-card shadow-sm border p-3 p-md-4 mb-4">
        
        <div class="row">
            <div class="col-lg-6 mb-3 mb-lg-0">
                <div id="roomCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner rounded">
                        {% if room.image1 %}
                        <div class="carousel-item active">
                            <img src="{{ room.image1.url }}" class="d-block w-100 room-image" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á 1">
                        </div>
                        {% endif %}
                        {% if room.image2 %}
                        <div class="carousel-item {% if not room.image1 %}active{% endif %}">
                            <img src="{{ room.image2.url }}" class="d-block w-100 room-image" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á 2">
                        </div>
                        {% endif %}
                        {% if room.image3 %}
                        <div class="carousel-item {% if not room.image1 and not room.image2 %}active{% endif %}">
                            <img src="{{ room.image3.url }}" class="d-block w-100 room-image" alt="‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≠‡∏á 3">
                        </div>
                        {% endif %}
                        {% if not room.image1 and not room.image2 and not room.image3 %}
                            <div class="carousel-item active">
                                <div class="bg-light text-muted d-flex align-items-center justify-content-center room-image">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
                            </div>
                        {% endif %}
                    </div>
                    {% if room.image2 or room.image3 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#roomCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#roomCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-6">
                <h4 class="fw-bold text-primary">{{ room.name }}</h4>
                <p class="text-muted small mb-3">{{ room.location|default:"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏∏)" }}</p>
                <p class="mb-2">
                    <i class="bi bi-people-fill me-2 text-muted"></i> 
                    <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {{ room.capacity }} ‡∏Ñ‡∏ô
                </p>
                <p class="mb-2">
                    <i class="bi bi-building me-2 text-muted"></i> 
                    <strong>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> {{ room.building|default:"-" }} (‡∏ä‡∏±‡πâ‡∏ô {{ room.floor|default:"-" }})
                </p>
                <p class="mb-1">
                    <i class="bi bi-tools me-2 text-muted"></i> 
                    <strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong>
                </p>
                <div class="small text-muted ps-4 mt-1">
                    {{ room.equipment_in_room|default:"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏ö‡∏∏)"|linebreaksbr }}
                </div>
            </div>
        </div>

    </div>

    <div class="content-card shadow-sm border p-3 p-md-4">
        <h5 class="mb-0">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</h5>
        <div id="calendar"></div>
    </div>


    {# --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÅ‡∏•‡∏∞ Form (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) --- #}

    <div id="bookingFormContainer">
        <form id="hiddenBookingForm" action="{% url 'create_booking_for_room' room.id %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            {{ form.as_p }}
        </form>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {{ room.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBookingBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary" form="hiddenBookingForm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
            </div>
        </div>
    </div>
    {# --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ --- #}

{% endblock %}


{% block extra_scripts %}
<script src="{% static 'vendor/fullcalendar/main.min.js' %}" defer></script>
<script src="{% static 'vendor/fullcalendar/th.global.min.js' %}" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    // 1. [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Bootstrap ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Modal
    if (typeof FullCalendar === 'undefined') {
        console.error("FullCalendar JS not loaded. Cannot initialize.");
        alert("Error: FullCalendar JS ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö main.min.js");
        return; 
    }
    if (typeof bootstrap === 'undefined') {
        console.error("Bootstrap JS not loaded. Cannot initialize Modal.");
        alert("Error: Bootstrap JS ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå bootstrap.bundle.min.js ‡πÉ‡∏ô base.html");
        return; 
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Modal ‡πÅ‡∏•‡∏∞ Form
    var hiddenForm = document.getElementById('hiddenBookingForm');
    var modalBody = document.getElementById('modalBookingBody');
    var startTimeField = document.getElementById('id_start_time');
    var endTimeField = document.getElementById('id_end_time');
    var bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    
    // 2. Initial Calendar
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek', // ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
        locale: 'th',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: { today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', day: '‡∏ß‡∏±‡∏ô' },
        allDaySlot: false, 
        slotMinTime: '08:00:00',
        slotMaxTime: '19:00:00',
        
        selectable: true, // ‚¨ÖÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á)
        selectMirror: true, 
        nowIndicator: true, 
        
        selectAllow: function(selectInfo) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            var now = new Date();
            if (selectInfo.start < now) {
                return false; 
            }
            return true;
        },

        select: function(info) {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå)
            
            // üí° [DEBUG] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏ñ‡∏π‡∏Å‡∏£‡∏±‡∏ô‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            console.log("--- Select event triggered ---");
            console.log("Start time:", info.start.toISOString());
            
            var now = new Date();
            if (info.start < now) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");
                calendar.unselect();
                return;
            }

            // 1. Format ‡πÄ‡∏ß‡∏•‡∏≤
            var startStr = info.start.toISOString().substring(0, 16);
            var endStr = info.end.toISOString().substring(0, 16);
            
            // 2. ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Modal, ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤, ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î Modal
            modalBody.appendChild(hiddenForm); 
            startTimeField.value = startStr;
            endTimeField.value = endStr;
            
            // 3. ‡πÅ‡∏™‡∏î‡∏á Modal
            if (bookingModal) {
                 bookingModal.show();
            } else {
                 // üö® [DEBUG ALERT] ‡∏ñ‡πâ‡∏≤ Modal ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                 alert("Error: Modal object ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Bootstrap JS");
            }
        },
        
        // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ---
        events: "{% url 'api_bookings' %}?room_id={{ room.id }}",

        eventDataTransform: function(eventData) {
            let props = eventData.extendedProps || {};
            if (props.status === 'PENDING') {
                eventData.backgroundColor = '#ffc107';
                eventData.borderColor = '#ffc107';
            } else if (props.status === 'APPROVED') {
                eventData.backgroundColor = '#198754';
                eventData.borderColor = '#198754';
            } else {
                eventData.display = 'none';
            }
            return eventData;
        },

        eventClick: function(info) {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Event ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
            window.location.href = "{% url 'booking_detail' 0 %}".replace('0', info.event.id);
        },
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Modal ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        viewDidMount: function() {
            bookingModal._element.addEventListener('hidden.bs.modal', function () {
                document.getElementById('bookingFormContainer').appendChild(hiddenForm);
            });
        }
    });
    
    calendar.render();
});

// ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Select2 ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î Modal
$(document).ready(function() {
    // ‡πÉ‡∏ä‡πâ delegated event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Select2 ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Modal
    $('#bookingModal').on('shown.bs.modal', function () {
        // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ JQuery ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
        if (typeof $ !== 'undefined' && $.fn.select2) {
            $('#id_participants').select2({
                dropdownParent: $('#bookingModal')
            });
        }
    });
});
</script>
{% endblock %}